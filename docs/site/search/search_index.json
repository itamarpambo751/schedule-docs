{"config":{"lang":["pt"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"1. Apresenta\u00e7\u00e3o do Problema e da Ideia do Sistema","text":""},{"location":"#11-o-problema-que-o-sistema-resolve","title":"1.1 O problema que o sistema resolve","text":"<p>Em qualquer unidade de sa\u00fade (hospital, cl\u00ednica ou consult\u00f3rio):</p> <ul> <li>H\u00e1 m\u00faltiplos profissionais, cada um com hor\u00e1rios diferentes.</li> <li>Consultas podem ser presenciais, online (telemedicina) ou domiciliares.</li> <li>Pacientes t\u00eam idades, g\u00eaneros, restri\u00e7\u00f5es de plano de sa\u00fade e prefer\u00eancias.</li> <li>Algumas datas ou hor\u00e1rios n\u00e3o podem ser usados (feriados, reuni\u00f5es, folgas).</li> </ul> <p>Se cada consulta fosse marcada manual ou isoladamente, surgiriam problemas s\u00e9rios:</p> <ul> <li>Conflitos de hor\u00e1rio: dois pacientes marcados para o mesmo m\u00e9dico ao mesmo tempo.</li> <li>Inefici\u00eancia: agendas subutilizadas ou hor\u00e1rios vagos desperdi\u00e7ados.</li> <li>Erros humanos: esquecimento de folgas, feriados ou hor\u00e1rios de almo\u00e7o.</li> <li>Dificuldade de previs\u00e3o: n\u00e3o se sabe quantos atendimentos v\u00e3o ocorrer em cada dia.</li> </ul> <p>O sistema existe para resolver essas dores de forma automatizada e confi\u00e1vel.</p>"},{"location":"#12-a-ideia-central-do-sistema","title":"1.2 A ideia central do sistema","text":"<p>O sistema n\u00e3o trata cada consulta individualmente antes de existir um hor\u00e1rio. Ele trabalha assim:</p> <ol> <li> <p>Agenda    Define as regras gerais do atendimento: dias da semana, hor\u00e1rios, dura\u00e7\u00e3o das consultas, tipo de servi\u00e7o, categoria da especialidade e limita\u00e7\u00f5es (g\u00eanero, idade, etc.).</p> </li> <li> <p>Slot (dia de atendimento)    Cada dia que se enquadra na agenda se torna um slot, que representa todo o conjunto de hor\u00e1rios poss\u00edveis daquele dia, e n\u00e3o cada hora individualmente. O slot \u00e9 o \u201ccontainer\u201d que vai receber hor\u00e1rios espec\u00edficos (HourBox) mais tarde.</p> </li> <li> <p>HourBox (hor\u00e1rio real dentro do slot)    Com base na agenda, na dura\u00e7\u00e3o das consultas e nas regras de capacidade, o sistema gera hor\u00e1rios dispon\u00edveis para marca\u00e7\u00e3o dentro de cada slot.    Esses hor\u00e1rios s\u00e3o o que o paciente ver\u00e1 para marcar consulta.</p> </li> <li> <p>Recorr\u00eancia    Permite que a agenda se repita no tempo, gerando slots automaticamente em dias futuros, sem precisar criar manualmente cada dia.</p> </li> <li> <p>Exclus\u00f5es    Permite remover dias ou hor\u00e1rios espec\u00edficos da agenda (feriados, folgas, reuni\u00f5es), mesmo que a regra geral diga que deveria haver atendimento.</p> </li> <li> <p>Hor\u00e1rios de trabalho dos profissionais    Cada profissional define quando est\u00e1 dispon\u00edvel. O sistema s\u00f3 atribui profissionais aos hor\u00e1rios de um slot se eles estiverem realmente trabalhando naquele dia e hor\u00e1rio.</p> </li> <li> <p>Marca\u00e7\u00e3o de consultas    S\u00f3 depois que os slots e hor\u00e1rios s\u00e3o gerados \u00e9 que o paciente consegue marcar. Isso garante que n\u00e3o haja conflitos e que todas as regras sejam respeitadas automaticamente.</p> </li> </ol>"},{"location":"#13-por-que-isso-importa","title":"1.3 Por que isso importa","text":"<ul> <li>Agilidade: evita a necessidade de confer\u00eancias manuais de agendas.</li> <li>Seguran\u00e7a: aplica todas as regras automaticamente (idade, g\u00eanero, folgas, feriados).</li> <li>Escalabilidade: permite gerenciar dezenas de profissionais e centenas de pacientes sem erro.</li> <li>Transpar\u00eancia: cada passo (gera\u00e7\u00e3o de slot, atribui\u00e7\u00e3o de profissional, exclus\u00e3o, marca\u00e7\u00e3o) \u00e9 registrado e audit\u00e1vel.</li> </ul>"},{"location":"10/","title":"10. Exclus\u00f5es e Bloqueios Avan\u00e7ados (ExcludeDay e ExcludeRange)","text":"<p>O sistema permite que dias ou per\u00edodos inteiros sejam bloqueados para agendamento. Isso garante que consultas n\u00e3o possam ser marcadas em datas ou hor\u00e1rios indispon\u00edveis, seja por feriado, manuten\u00e7\u00e3o, reuni\u00e3o ou indisponibilidade de profissionais.</p> <p>Existem dois tipos principais de exclus\u00e3o:</p> <ol> <li>ExcludeDay \u2192 Bloqueia dias inteiros ou padr\u00f5es de dias da semana</li> <li>ExcludeRange \u2192 Bloqueia apenas determinados intervalos de hor\u00e1rio dentro de dias espec\u00edficos ou recorrentes</li> </ol>"},{"location":"10/#101-excludeday-bloqueio-de-dias-inteiros","title":"10.1 ExcludeDay \u2013 Bloqueio de Dias Inteiros","text":""},{"location":"10/#1011-o-que-e","title":"10.1.1 O que \u00e9","text":"<ul> <li>Representa um dia ou conjunto de dias da semana que deve ser exclu\u00eddo do agendamento.</li> <li>Pode ser espec\u00edfico (07/09/2024) ou recorrente (todas as segundas-feiras).</li> </ul>"},{"location":"10/#1012-campos-importantes","title":"10.1.2 Campos importantes","text":"Campo Fun\u00e7\u00e3o SpecificDate Data exata a ser bloqueada (opcional) WeekDays Lista de dias da semana a bloquear (segunda, ter\u00e7a\u2026) TypeOfRecurrence Recorr\u00eancia do bloqueio (Di\u00e1rio, Semanal, Mensal\u2026) ExclusionVisibility Onde o bloqueio ser\u00e1 aplicado (Sistema, Unidade, Especialidade) Title / Reason Nome e motivo da exclus\u00e3o (ex: \u201cFeriado Nacional\u201d) DefinedBy Quem definiu o bloqueio"},{"location":"10/#1013-exemplo-pratico","title":"10.1.3 Exemplo pr\u00e1tico","text":"<p>Cen\u00e1rio: Hospital ter\u00e1 feriado em 07/09/2024.</p> <p>Passos no sistema:</p> <ol> <li>Criar novo ExcludeDay</li> <li>Definir <code>SpecificDate = 07/09/2024</code></li> <li><code>ExclusionVisibility = HEALTH_UNIT</code></li> <li><code>Title = \"Feriado Nacional\"</code></li> <li><code>Reason = \"Independ\u00eancia do Brasil\"</code></li> <li>Salvar</li> </ol> <p>Resultado: Nenhum slot ser\u00e1 gerado para 07/09/2024, impossibilitando marca\u00e7\u00e3o de consultas.</p>"},{"location":"10/#1014-exemplo-recorrente","title":"10.1.4 Exemplo recorrente","text":"<p>Cen\u00e1rio: Toda segunda-feira, equipe tem reuni\u00e3o das 14h \u00e0s 15h.</p> <ul> <li>Criar ExcludeDay com <code>WeekDays = MONDAY</code></li> <li><code>TypeOfRecurrence = WEEKLY</code></li> <li><code>ExclusionVisibility = HEALTH_UNIT</code></li> <li>Sistema aplicar\u00e1 automaticamente essa exclus\u00e3o em todas as segundas-feiras futuras, ajustando slots gerados.</li> </ul>"},{"location":"10/#102-excluderange-bloqueio-de-intervalos-de-horario","title":"10.2 ExcludeRange \u2013 Bloqueio de Intervalos de Hor\u00e1rio","text":""},{"location":"10/#1021-o-que-e","title":"10.2.1 O que \u00e9","text":"<ul> <li>Bloqueia somente hor\u00e1rios espec\u00edficos dentro de um dia ou slot.</li> <li>Ideal para feriados parciais, reuni\u00f5es ou hor\u00e1rios de manuten\u00e7\u00e3o de equipamentos.</li> </ul>"},{"location":"10/#1022-campos-importantes","title":"10.2.2 Campos importantes","text":"Campo Fun\u00e7\u00e3o StartTime / EndTime Intervalo de hor\u00e1rio a bloquear StartDate / EndDate Per\u00edodo em que a exclus\u00e3o vale ExcludeForAllSlots Bloqueia todos os slots do dia ou apenas os selecionados ExcludeFor Lista de dias da semana aplic\u00e1veis ExcludeForSpecificDates Lista de datas espec\u00edficas TypeOfRecurrence Recorr\u00eancia do bloqueio (semanal, mensal, etc.) ExclusionVisibility Onde o bloqueio ser\u00e1 aplicado Title / Reason Nome e motivo do bloqueio"},{"location":"10/#1023-exemplo-pratico","title":"10.2.3 Exemplo pr\u00e1tico","text":"<p>Cen\u00e1rio: Dra. Ana vai tirar f\u00e9rias de 15 a 30 de julho, mas s\u00f3 nas tardes.</p> <ul> <li>Criar ExcludeRange</li> <li><code>StartDate = 15/07/2024</code>, <code>EndDate = 30/07/2024</code></li> <li><code>StartTime = 13:00</code>, <code>EndTime = 18:00</code></li> <li><code>ExclusionVisibility = HEALTH_UNIT</code></li> <li><code>Reason = \"F\u00e9rias Dra. Ana\"</code></li> </ul> <p>Resultado:</p> <ul> <li>Slots gerados para essas datas ter\u00e3o hourboxes bloqueadas entre 13:00 e 18:00</li> <li>Pacientes n\u00e3o poder\u00e3o marcar consultas nesse per\u00edodo</li> </ul>"},{"location":"10/#1024-recorrencias-e-impacto","title":"10.2.4 Recorr\u00eancias e impacto","text":"<ul> <li>Di\u00e1rio: bloqueia todos os dias dentro do per\u00edodo</li> <li>Semanal: bloqueia determinados dias da semana</li> <li>Mensal: bloqueia datas espec\u00edficas de cada m\u00eas</li> <li>Anual: bloqueia feriados ou datas fixas todos os anos</li> </ul> <p>O sistema aplica essas regras durante a gera\u00e7\u00e3o autom\u00e1tica de slots, garantindo que nenhum hourbox inv\u00e1lido seja criado.</p>"},{"location":"10/#103-integracao-com-slots-e-agendas","title":"10.3 Integra\u00e7\u00e3o com Slots e Agendas","text":"<ul> <li>Antes de gerar hourboxes, o sistema verifica todas as exclus\u00f5es aplic\u00e1veis (ExcludeDay e ExcludeRange)</li> <li>Slots em dias totalmente bloqueados n\u00e3o s\u00e3o criados</li> <li>Para ranges parciais, apenas hourboxes dentro do intervalo s\u00e3o bloqueadas</li> <li>Atribui\u00e7\u00e3o de profissionais aos slots tamb\u00e9m respeita as exclus\u00f5es</li> </ul>"},{"location":"11/","title":"11. Hor\u00e1rios de Trabalho de Profissionais (WorkingHours)","text":"<p>O sistema permite registrar hor\u00e1rios de trabalho individuais para cada profissional de sa\u00fade. Essa configura\u00e7\u00e3o \u00e9 essencial para que a agenda funcione corretamente, garantindo que os slots s\u00f3 sejam criados em hor\u00e1rios em que o profissional est\u00e1 dispon\u00edvel.</p>"},{"location":"11/#111-conceito","title":"11.1 Conceito","text":"<ul> <li>Cada profissional pode ter v\u00e1rios hor\u00e1rios de trabalho por semana, em diferentes dias e hor\u00e1rios.</li> <li>Cada hor\u00e1rio \u00e9 vinculado a uma unidade de sa\u00fade e a uma especialidade.</li> <li>\u00c9 poss\u00edvel registrar per\u00edodos de validade, caso o profissional s\u00f3 trabalhe temporariamente ou em datas espec\u00edficas.</li> <li>Hor\u00e1rios podem ter exclus\u00f5es (feriados, f\u00e9rias, reuni\u00f5es).</li> </ul> <p>Exemplo:</p> <ul> <li> <p>Dra. Ana, cardiologista:</p> </li> <li> <p>Segunda a sexta: 13:00 \u00e0s 18:00</p> </li> <li>S\u00e1bado: 08:00 \u00e0s 12:00</li> <li>Domingo: folga</li> </ul>"},{"location":"11/#112-campos-importantes","title":"11.2 Campos importantes","text":"Campo Fun\u00e7\u00e3o ProfessionalTaxId Identificador do profissional (CPF) HealthUnitTaxId Unidade de sa\u00fade onde atua SpecialityCode C\u00f3digo da especialidade (ex: CARD para Cardiologia) WeekDay Dia da semana StartAt / EndsAt Hor\u00e1rio de in\u00edcio e fim ValidFrom / ValidTo Per\u00edodo de validade do hor\u00e1rio (opcional) TypeOfService Tipo de atendimento: presencial, telemedicina ou domiciliar ExcludedDays / ExcludedRanges Dias e hor\u00e1rios bloqueados que afetam esse hor\u00e1rio"},{"location":"11/#113-exemplo-pratico","title":"11.3 Exemplo pr\u00e1tico","text":"<p>Cen\u00e1rio: Dr. Jo\u00e3o \u00e9 pediatra e trabalha em duas unidades de sa\u00fade com hor\u00e1rios distintos.</p> Unidade Dia Hor\u00e1rio Hospital S\u00e3o Lucas Seg a Sex 08:00 \u2013 12:00 Cl\u00ednica S\u00e3o Jos\u00e9 Seg a Sex 14:00 \u2013 18:00 <p>Configura\u00e7\u00e3o no sistema:</p> <ol> <li>Criar WorkingHour para cada combina\u00e7\u00e3o de unidade e dia</li> <li>Definir <code>StartAt</code>, <code>EndsAt</code>, <code>WeekDay</code></li> <li>Definir <code>SpecialityCode = PED</code></li> <li>Adicionar exclus\u00f5es se necess\u00e1rio (feriados, f\u00e9rias)</li> <li>Salvar</li> </ol> <p>Resultado: Sistema sabe exatamente quando Dr. Jo\u00e3o est\u00e1 dispon\u00edvel e s\u00f3 gera slots nesses hor\u00e1rios.</p>"},{"location":"11/#114-relacao-com-slots-e-agendas","title":"11.4 Rela\u00e7\u00e3o com Slots e Agendas","text":"<ul> <li> <p>Durante a gera\u00e7\u00e3o autom\u00e1tica de slots em uma agenda:</p> </li> <li> <p>Sistema verifica todos os hor\u00e1rios de trabalho ativos dos profissionais dispon\u00edveis</p> </li> <li>Apenas cria slots em dias e hor\u00e1rios compat\u00edveis</li> <li> <p>Atribui automaticamente os profissionais aos slots, respeitando:</p> <ul> <li>Dias da semana</li> <li>Hor\u00e1rios</li> <li>Tipo de servi\u00e7o</li> <li>Exce\u00e7\u00f5es de exclus\u00e3o</li> <li>Se uma agenda tiver <code>EachSlotInheritAllScheduleProfessionals = true</code>, cada slot herda todos os profissionais compat\u00edveis para aquele dia/hora.</li> </ul> </li> </ul>"},{"location":"11/#115-exemplos-de-exclusoes","title":"11.5 Exemplos de exclus\u00f5es","text":"<ul> <li>F\u00e9rias: Dr. Jo\u00e3o tira f\u00e9rias de 10 a 20/07 \u2192 hor\u00e1rio marcado como exclu\u00eddo no WorkingHour</li> <li>Reuni\u00e3o: Segunda-feira, 15:00 \u00e0s 16:00 \u2192 intervalo bloqueado</li> <li>Manuten\u00e7\u00e3o: S\u00e1bado, 08:00 \u00e0s 09:00 \u2192 bloqueio parcial</li> </ul> <p>O sistema calcula automaticamente que n\u00e3o haver\u00e1 slots dispon\u00edveis nesses hor\u00e1rios.</p>"},{"location":"11/#116-beneficios","title":"11.6 Benef\u00edcios","text":"<ul> <li>Garante que nenhum slot seja criado fora da disponibilidade real do profissional</li> <li>Permite atribui\u00e7\u00e3o autom\u00e1tica de profissionais aos slots</li> <li>Evita marca\u00e7\u00f5es incorretas, cancelamentos ou conflitos de agenda</li> <li>Facilita gest\u00e3o de m\u00faltiplos profissionais em v\u00e1rias unidades e especialidades</li> </ul>"},{"location":"2/","title":"2. Conceitos-base do Sistema","text":""},{"location":"2/#21-agenda","title":"2.1 Agenda","text":"<p>A Agenda \u00e9 a regra-mestra do agendamento. Ela define quando e como o atendimento ocorre.</p>"},{"location":"2/#componentes-de-uma-agenda","title":"Componentes de uma Agenda:","text":"<ul> <li>Unidade de Sa\u00fade: hospital, cl\u00ednica ou consult\u00f3rio onde ocorre o atendimento.</li> <li>Especialidade / Categoria: Pediatria, Cl\u00ednica Geral, Dermatologia, Exames, Vacinas.</li> <li>Dias da Semana: Segunda a sexta, apenas ter\u00e7as, etc.</li> <li>Hor\u00e1rio de Atendimento: in\u00edcio e fim do expediente.</li> <li>Dura\u00e7\u00e3o da Consulta: ex: 30 minutos por paciente.</li> <li>Capacidade por hor\u00e1rio: quantos pacientes podem ser atendidos simultaneamente.</li> <li>Recorr\u00eancia: define se a agenda se repete em dias futuros (di\u00e1ria, semanal, mensal, etc.).</li> <li>Tipo de Servi\u00e7o: presencial, telemedicina ou domiciliar.</li> <li>Restri\u00e7\u00f5es: idade, g\u00eanero, especialidade do paciente.</li> <li>Profissionais dispon\u00edveis: lista de m\u00e9dicos que podem atender dentro da agenda.</li> <li>Exclus\u00f5es: dias ou hor\u00e1rios que devem ser bloqueados (feriados, reuni\u00f5es, f\u00e9rias de profissionais).</li> </ul>"},{"location":"2/#exemplo-pratico-de-agenda","title":"Exemplo pr\u00e1tico de Agenda","text":"<p>Suponha que o Hospital S\u00e3o Lucas quer criar uma agenda de Pediatria para o Dr. Carlos:</p> <ul> <li>Dias da semana: Segunda, Quarta e Sexta</li> <li>Hor\u00e1rio: 08:00 \u00e0s 12:00</li> <li>Dura\u00e7\u00e3o da consulta: 30 minutos</li> <li>Capacidade por hor\u00e1rio: 2 pacientes</li> <li>Tipo de servi\u00e7o: Presencial</li> <li>Restri\u00e7\u00f5es de idade: at\u00e9 18 anos</li> <li>Profissionais dispon\u00edveis: Dr. Carlos, Dra. Ana</li> <li>Recorr\u00eancia: semanal (agenda se repete toda segunda, quarta e sexta at\u00e9 uma data final)</li> </ul> <p>Com essas regras, a agenda n\u00e3o cria hor\u00e1rios ainda, ela apenas define a forma e regras que os slots e hor\u00e1rios seguir\u00e3o.</p>"},{"location":"2/#22-slot","title":"2.2 Slot","text":"<p>O Slot representa um dia espec\u00edfico dentro da agenda.</p> <p>Diferente do HourBox, o slot n\u00e3o \u00e9 um hor\u00e1rio, mas sim o \u201ccontainer\u201d que conter\u00e1 todos os hor\u00e1rios daquele dia, respeitando a dura\u00e7\u00e3o da consulta, capacidade e profissionais dispon\u00edveis.</p>"},{"location":"2/#componentes-do-slot","title":"Componentes do Slot:","text":"<ul> <li>Data espec\u00edfica (ex: 15/04/2024) ou calculada a partir de uma agenda recorrente.</li> <li>Capacidade do dia: quantos pacientes podem ser atendidos por hor\u00e1rio.</li> <li>Profissionais atribu\u00eddos: automaticamente com base na disponibilidade definida no hor\u00e1rio de trabalho de cada profissional.</li> <li>Status do Slot: aberto, fechado ou bloqueado.</li> <li>Visibilidade: se o slot j\u00e1 pode aparecer para marca\u00e7\u00e3o ou ainda est\u00e1 em rascunho.</li> <li>Exclus\u00f5es: feriados, reuni\u00f5es ou folgas que afetam aquele dia espec\u00edfico.</li> </ul>"},{"location":"2/#exemplo-pratico-de-slot","title":"Exemplo pr\u00e1tico de Slot","text":"<ul> <li>Agenda: Pediatria, Segunda, 08:00-12:00, 30 minutos de dura\u00e7\u00e3o</li> <li>Slot gerado: Segunda, 15/04/2024</li> <li>Hor\u00e1rios dentro do Slot (HourBoxes): 08:00, 08:30, 09:00, 09:30, 10:00, 10:30, 11:00, 11:30</li> <li>Cada HourBox ter\u00e1 capacidade para 2 pacientes</li> <li>Profissionais atribu\u00eddos: Dr. Carlos (dispon\u00edvel nesse dia e hor\u00e1rio)</li> </ul> <p>Observa\u00e7\u00e3o: se houver uma exclus\u00e3o, como feriado em 15/04/2024, o slot ser\u00e1 bloqueado automaticamente, e os hor\u00e1rios n\u00e3o estar\u00e3o dispon\u00edveis para marca\u00e7\u00e3o.</p>"},{"location":"2/#23-hourbox-horario-real-de-consulta","title":"2.3 HourBox (Hor\u00e1rio Real de Consulta)","text":"<p>O HourBox \u00e9 o hor\u00e1rio espec\u00edfico dentro do slot, que pode ser reservado por um paciente.</p>"},{"location":"2/#componentes-do-hourbox","title":"Componentes do HourBox:","text":"<ul> <li>Hora espec\u00edfica (ex: 08:00)</li> <li>Status:</li> <li>AVAILABLE: dispon\u00edvel para marca\u00e7\u00e3o</li> <li>BOOKED: reservado com confirma\u00e7\u00e3o</li> <li>HELD: temporariamente reservado (aguardando pagamento ou aprova\u00e7\u00e3o)</li> <li>CANCELLED: cancelado</li> <li>BLOCKED: indispon\u00edvel por exclus\u00e3o ou regra da agenda</li> <li>Capacidade: quantos pacientes podem ser atendidos simultaneamente</li> <li>Profissional atribu\u00eddo: automaticamente baseado na agenda e no hor\u00e1rio de trabalho</li> <li>Link da telemedicina (quando aplic\u00e1vel)</li> </ul>"},{"location":"2/#exemplo-de-hourbox","title":"Exemplo de HourBox","text":"<p>Slot: 15/04/2024, 08:00 \u00e0s 12:00, dura\u00e7\u00e3o 30 minutos, capacidade 2</p> Hora Status Profissional Capacidade 08:00 AVAILABLE Dr. Carlos 2 08:30 BOOKED Dr. Carlos 2 09:00 AVAILABLE Dra. Ana 2 <p>Cada paciente reserva um HourBox, garantindo que n\u00e3o haja conflito.</p>"},{"location":"2/#24-recorrencia","title":"2.4 Recorr\u00eancia","text":"<p>A recorr\u00eancia define como a agenda se repete no tempo, criando automaticamente slots futuros.</p>"},{"location":"2/#tipos-de-recorrencia","title":"Tipos de recorr\u00eancia:","text":"<ul> <li>Di\u00e1ria: agenda se repete todos os dias \u00fateis</li> <li>Semanal: agenda se repete em determinados dias da semana (segunda, quarta e sexta)</li> <li>Mensal: agenda se repete em um dia espec\u00edfico do m\u00eas</li> <li>Anual ou personalizada: para datas especiais ou per\u00edodos sazonais</li> </ul>"},{"location":"2/#impacto-da-recorrencia","title":"Impacto da Recorr\u00eancia","text":"<ol> <li>Gera automaticamente slots futuros conforme a regra.</li> <li>Reduz trabalho manual: n\u00e3o \u00e9 necess\u00e1rio criar cada dia individualmente.</li> <li>Permite aplicar exclus\u00f5es: feriados, reuni\u00f5es ou folgas podem sobrepor slots gerados.</li> </ol>"},{"location":"2/#exemplo-pratico","title":"Exemplo pr\u00e1tico:","text":"<ul> <li>Agenda semanal: Segunda e Quinta, 08:00-12:00, dura\u00e7\u00e3o 30 minutos</li> <li>Recorr\u00eancia semanal</li> <li>Sistema gera slots automaticamente:</li> <li>08/04/2024 (Segunda)</li> <li>11/04/2024 (Quinta)</li> <li>15/04/2024 (Segunda)</li> <li>18/04/2024 (Quinta)</li> <li>Cada slot ter\u00e1 seus pr\u00f3prios HourBoxes</li> </ul>"},{"location":"2/#25-tipos-de-slots-capacidade-x-timed","title":"2.5 Tipos de Slots (Capacidade x Timed)","text":"<p>O modo do slot define como os hor\u00e1rios internos s\u00e3o tratados:</p> <ol> <li>Timed (Hor\u00e1rios fixos):</li> <li>Cada HourBox tem hor\u00e1rio espec\u00edfico, ex: 08:00, 08:30, 09:00</li> <li>Limita capacidade por hor\u00e1rio</li> <li> <p>Ideal para consultas padr\u00e3o, telemedicina ou exames</p> </li> <li> <p>Capacity (Baseado em capacidade total do dia):</p> </li> <li>Hor\u00e1rios n\u00e3o importam, apenas limite de pacientes por slot</li> <li>Sistema distribui consultas internamente</li> <li> <p>Ideal para vacinas ou exames r\u00e1pidos</p> </li> <li> <p>Unlimited:</p> </li> <li>Sem limite de marca\u00e7\u00f5es</li> <li>Usado quando n\u00e3o h\u00e1 restri\u00e7\u00e3o de n\u00famero de pacientes</li> </ol>"},{"location":"3/","title":"3. Exclus\u00f5es e Folgas","text":"<p>No sistema, nem todos os dias e hor\u00e1rios de uma agenda estar\u00e3o dispon\u00edveis para marca\u00e7\u00e3o. Isso pode ocorrer por:</p> <ul> <li>Feriados</li> <li>Reuni\u00f5es ou eventos internos da unidade</li> <li>F\u00e9rias ou folgas de profissionais</li> <li>Bloqueios espec\u00edficos de especialidade</li> </ul> <p>Esses bloqueios s\u00e3o tratados por ExcludeDay (dia espec\u00edfico) e ExcludeRange (per\u00edodo de tempo) e se aplicam automaticamente aos slots gerados.</p>"},{"location":"3/#31-excludeday-bloqueio-de-dia-especifico","title":"3.1 ExcludeDay (Bloqueio de Dia Espec\u00edfico)","text":"<p>O ExcludeDay serve para bloquear datas inteiras, independentemente dos hor\u00e1rios internos.</p>"},{"location":"3/#componentes","title":"Componentes:","text":"<ul> <li>SpecificDate: data exata do bloqueio (ex: 07/09/2024)</li> <li>WeekDays: se for recorrente semanalmente (ex: toda segunda-feira)</li> <li>TypeOfRecurrence: di\u00e1ria, semanal, mensal, personalizada</li> <li>ExclusionVisibility: quem v\u00ea ou \u00e9 afetado (sistema, unidade, especialidade)</li> <li>Reason: motivo do bloqueio</li> <li>DefinedBy: quem criou o bloqueio</li> </ul>"},{"location":"3/#exemplo-pratico","title":"Exemplo pr\u00e1tico:","text":"<ul> <li>Motivo: Feriado nacional</li> <li>Data: 07/09/2024</li> <li>Visibilidade: Todos (SYSTEM)</li> <li> <p>A\u00e7\u00e3o do sistema:</p> </li> <li> <p>Todos os slots criados para 07/09/2024 ficam bloqueados</p> </li> <li>HourBoxes desse dia n\u00e3o podem ser reservados</li> <li>Se j\u00e1 houver consultas, sistema notifica pacientes e profissionais</li> </ul>"},{"location":"3/#32-excluderange-bloqueio-de-periodo-ou-horario","title":"3.2 ExcludeRange (Bloqueio de Per\u00edodo ou Hor\u00e1rio)","text":"<p>O ExcludeRange permite bloquear hor\u00e1rios espec\u00edficos, dentro de um ou v\u00e1rios dias.</p>"},{"location":"3/#componentes_1","title":"Componentes:","text":"<ul> <li>StartTime / EndTime: intervalo de horas (ex: 14:00-16:00)</li> <li>StartDate / EndDate: per\u00edodo do bloqueio (ex: 15/07 a 30/07)</li> <li>ExcludeForAllSlots: se deve afetar todos os slots do dia</li> <li>ExcludeFor: dias da semana espec\u00edficos</li> <li>ExcludeForSpecificDates: datas exatas</li> <li>TypeOfRecurrence: di\u00e1ria, semanal, mensal, personalizada</li> <li>ExclusionVisibility e Reason</li> </ul>"},{"location":"3/#exemplo-pratico_1","title":"Exemplo pr\u00e1tico:","text":"<ul> <li>Motivo: Reuni\u00e3o da equipe</li> <li>Per\u00edodo: 14:00 \u00e0s 15:00</li> <li>Recorr\u00eancia: semanal, toda segunda-feira</li> <li> <p>Impacto:</p> </li> <li> <p>Slots gerados para segunda-feira ter\u00e3o HourBoxes entre 14:00 e 15:00 bloqueados automaticamente</p> </li> <li>Pacientes n\u00e3o podem reservar esses hor\u00e1rios</li> <li>Profissionais s\u00e3o notificados do bloqueio</li> </ul>"},{"location":"3/#33-folgas-e-ferias-de-profissionais","title":"3.3 Folgas e F\u00e9rias de Profissionais","text":"<p>O sistema tamb\u00e9m integra trabalho dos profissionais com exclus\u00f5es:</p> <ol> <li>Cada profissional possui hor\u00e1rios de trabalho (WorkingHour).</li> <li>Se o profissional estiver de folga ou f\u00e9rias, o sistema cria automaticamente ExcludeRange ou ExcludeDay para os slots que coincidem com os hor\u00e1rios do profissional.</li> <li>Ao gerar os slots da agenda, o sistema atribui apenas os profissionais dispon\u00edveis em cada HourBox.</li> </ol>"},{"location":"3/#exemplo-pratico_2","title":"Exemplo pr\u00e1tico:","text":"<ul> <li>Dra. Ana (Cardiologista) trabalha:</li> <li>Segunda a sexta: 13:00-18:00</li> <li>S\u00e1bado: 08:00-12:00</li> <li>F\u00e9rias: 15/07/2024 a 30/07/2024</li> </ul> <p>Resultado do sistema:</p> <ul> <li>Exclus\u00f5es autom\u00e1ticas criadas para esse per\u00edodo</li> <li>Slots gerados:</li> <li>Sem Dra. Ana</li> <li>Se houver outros profissionais, eles ser\u00e3o atribu\u00eddos</li> <li>Se Dra. Ana for a \u00fanica profissional, o slot pode ser bloqueado</li> </ul>"},{"location":"3/#34-interacao-com-slots-e-hourboxes","title":"3.4 Intera\u00e7\u00e3o com Slots e HourBoxes","text":"<ul> <li>Slots j\u00e1 gerados podem ser atualizados automaticamente ao criar uma exclus\u00e3o.</li> <li>HourBoxes afetados pelo bloqueio:</li> <li>Se estiverem AVAILABLE, mudam para BLOCKED</li> <li>Se j\u00e1 estiverem BOOKED, o sistema notifica o paciente e sugere remarca\u00e7\u00e3o</li> <li>Tipos de visibilidade permitem aplicar o bloqueio apenas a:</li> <li>Sistema inteiro</li> <li>Unidade de sa\u00fade</li> <li>Especialidade espec\u00edfica</li> <li>\u00c1rea m\u00e9dica</li> </ul>"},{"location":"3/#35-exemplos-combinados","title":"3.5 Exemplos combinados","text":""},{"location":"3/#cenario-1-feriado-profissional-de-folga","title":"Cen\u00e1rio 1: Feriado + Profissional de Folga","text":"<ul> <li>Agenda de Pediatria: Segunda a Sexta, 08:00-12:00</li> <li>Feriado: 15/04/2024</li> <li>Dra. Ana de f\u00e9rias: 14/04 a 18/04</li> </ul> <p>Resultado:</p> Data Slot Status HourBoxes dispon\u00edveis Profissional atribu\u00eddo 14/04/2024 Aberto 08:00-12:00 Dr. Carlos 15/04/2024 Bloqueado Todos Nenhum 16/04/2024 Aberto 08:00-12:00 Dr. Carlos 17/04/2024 Aberto 08:00-12:00 Dr. Carlos 18/04/2024 Aberto 08:00-12:00 Dr. Carlos"},{"location":"3/#cenario-2-bloqueio-parcial-reuniao-da-equipe","title":"Cen\u00e1rio 2: Bloqueio parcial (Reuni\u00e3o da equipe)","text":"<ul> <li>Bloqueio: Segunda-feira, 14:00-15:00</li> <li>Slot: 15/04/2024, 08:00-16:00, capacidade 2 por hor\u00e1rio</li> </ul> <p>Resultado HourBoxes:</p> Hora Status 08:00 AVAILABLE 08:30 AVAILABLE ... ... 14:00 BLOCKED 14:30 BLOCKED 15:00 AVAILABLE ... ... <p>O sistema garante que apenas hor\u00e1rios v\u00e1lidos fiquem dispon\u00edveis, mesmo que a agenda seja recorrente.</p>"},{"location":"4/","title":"4. Hor\u00e1rios de Trabalho dos Profissionais e Atribui\u00e7\u00e3o Autom\u00e1tica","text":"<p>No sistema, cada profissional possui WorkingHour, que define quando ele est\u00e1 dispon\u00edvel para atendimento. Essa informa\u00e7\u00e3o \u00e9 fundamental para gerar slots e HourBoxes corretos, garantindo que pacientes s\u00f3 possam marcar com profissionais realmente dispon\u00edveis.</p>"},{"location":"4/#41-estrutura-de-workinghour","title":"4.1 Estrutura de WorkingHour","text":"<p>Cada WorkingHour inclui:</p> <ul> <li>ProfessionalTaxId: identificador do profissional</li> <li>HealthUnitTaxId: unidade de sa\u00fade onde trabalha</li> <li>SpecialityCode: especialidade</li> <li>WeekDay: dia da semana (segunda, ter\u00e7a, etc.)</li> <li>StartAt / EndsAt: hor\u00e1rio de in\u00edcio e fim do atendimento</li> <li>ValidFrom / ValidTo: per\u00edodo de validade do hor\u00e1rio (ex: contrato tempor\u00e1rio, f\u00e9rias programadas)</li> <li>TypeOfService: presencial, telemedicina ou home care</li> <li>ExcludedDays / ExcludedRanges: bloqueios espec\u00edficos aplic\u00e1veis ao profissional</li> </ul>"},{"location":"4/#exemplo-pratico","title":"Exemplo pr\u00e1tico:","text":"<ul> <li>Dra. Ana (CRM: 12345), Cardiologista</li> <li>Unidade: Hospital S\u00e3o Lucas</li> <li>Segunda a Sexta: 13:00-18:00</li> <li>S\u00e1bado: 08:00-12:00</li> <li>Folga: Domingo</li> <li>F\u00e9rias: 15/07 a 30/07 (usando ExcludeRange)</li> </ul> <p>O sistema s\u00f3 poder\u00e1 gerar slots em hor\u00e1rios compat\u00edveis com esses dados.</p>"},{"location":"4/#42-integracao-com-agenda-schedule","title":"4.2 Integra\u00e7\u00e3o com Agenda (Schedule)","text":"<p>Quando uma agenda \u00e9 criada:</p> <ol> <li>Defini\u00e7\u00e3o da agenda: ex: Pediatria, Segunda a Sexta, 08:00-12:00</li> <li>Escolha dos profissionais: lista de AvailableProfessionalTaxIds ou todos dispon\u00edveis</li> <li>Recorr\u00eancia e datas: tipo de recorr\u00eancia da agenda (di\u00e1ria, semanal, mensal)</li> <li> <p>Gera\u00e7\u00e3o autom\u00e1tica de slots: para cada dia que bate com a agenda:</p> </li> <li> <p>O sistema verifica WorkingHours de cada profissional</p> </li> <li>Apenas profissionais com hor\u00e1rios compat\u00edveis s\u00e3o atribu\u00eddos aos slots</li> <li>Slots podem ser:<ul> <li>TIMED: cada HourBox tem dura\u00e7\u00e3o fixa (ex: 30min)</li> <li>CAPACITY: hora cheia com capacidade m\u00e1xima de pacientes</li> </ul> </li> </ol>"},{"location":"4/#43-processo-de-atribuicao-automatica","title":"4.3 Processo de Atribui\u00e7\u00e3o Autom\u00e1tica","text":"<ol> <li> <p>Para cada dia da agenda:</p> </li> <li> <p>Verifica se o dia n\u00e3o est\u00e1 em ExcludeDay</p> </li> <li> <p>Cria um Slot correspondente ao dia</p> </li> <li> <p>Para cada hora da agenda (StartTime \u2192 EndTime):</p> </li> <li> <p>Divide em HourBoxes conforme AppointmentDurationInMinutes</p> </li> <li>Verifica hor\u00e1rios ativos do profissional (WorkingHour)</li> <li> <p>Aplica Excludes (Dias e Per\u00edodos)</p> </li> <li> <p>Profissional \u00e9 atribu\u00eddo automaticamente:</p> </li> <li> <p>Se EachSlotInheritAllScheduleProfessionals = true, todos os profissionais dispon\u00edveis s\u00e3o atribu\u00eddos</p> </li> <li> <p>Caso contr\u00e1rio, pode ser manual ou limitado</p> </li> <li> <p>Slots e HourBoxes resultantes:</p> </li> <li> <p>S\u00f3 podem ser reservados se houver pelo menos um profissional dispon\u00edvel</p> </li> <li>HourBoxes em per\u00edodos bloqueados ficam BLOCKED</li> </ol>"},{"location":"4/#44-exemplos-praticos","title":"4.4 Exemplos Pr\u00e1ticos","text":""},{"location":"4/#cenario-1-slot-timed-com-multiplos-profissionais","title":"Cen\u00e1rio 1: Slot TIMED com m\u00faltiplos profissionais","text":"<ul> <li>Agenda: Segunda, 08:00-12:00, 30min por consulta</li> <li>Profissionais: Dra. Ana (13:00-18:00), Dr. Carlos (08:00-12:00)</li> </ul> <p>Resultado:</p> Hora HourBox Status Profissional atribu\u00eddo 08:00 AVAILABLE Dr. Carlos 08:30 AVAILABLE Dr. Carlos 09:00 AVAILABLE Dr. Carlos 13:00 AVAILABLE Dra. Ana 13:30 AVAILABLE Dra. Ana <p>Dra. Ana s\u00f3 \u00e9 atribu\u00edda nos hor\u00e1rios compat\u00edveis com seu WorkingHour.</p>"},{"location":"4/#cenario-2-slot-capacity-com-profissional-indisponivel","title":"Cen\u00e1rio 2: Slot CAPACITY com profissional indispon\u00edvel","text":"<ul> <li>Slot: 08:00-12:00, capacidade 2</li> <li>Dra. Ana em f\u00e9rias 09:00-11:00</li> </ul> <p>Resultado HourBoxes:</p> Hora Status Profissional dispon\u00edvel 08:00 AVAILABLE Dra. Ana 09:00 BLOCKED Nenhum 09:30 BLOCKED Nenhum 10:00 BLOCKED Nenhum 11:00 AVAILABLE Dra. Ana"},{"location":"4/#45-consideracoes-importantes","title":"4.5 Considera\u00e7\u00f5es importantes","text":"<ul> <li>Recorr\u00eancia da agenda: o sistema aplica automaticamente os WorkingHours de cada profissional em cada dia da recorr\u00eancia.</li> <li>Exclus\u00f5es: sempre s\u00e3o aplicadas antes da gera\u00e7\u00e3o de HourBoxes. Um HourBox s\u00f3 \u00e9 gerado se n\u00e3o houver conflito com ExcludeDay ou ExcludeRange.</li> <li>Slots vazios: se n\u00e3o houver profissional dispon\u00edvel, o slot inteiro pode ser bloqueado ou removido da publica\u00e7\u00e3o, dependendo das configura\u00e7\u00f5es.</li> <li>Telemedicina: se o tipo de servi\u00e7o for online, RoomLink \u00e9 gerado automaticamente para os HourBoxes atribu\u00eddos a cada profissional.</li> </ul>"},{"location":"5/","title":"5. Marca\u00e7\u00e3o de Consultas (Appointments)","text":"<p>O Appointment \u00e9 a entidade central para registrar que um paciente marcou uma consulta. Ele integra informa\u00e7\u00f5es do slot/dia, HourBox/hora espec\u00edfica, profissional, unidade de sa\u00fade, tipo de servi\u00e7o, e pagamento.</p>"},{"location":"5/#51-estrutura-de-appointment","title":"5.1 Estrutura de Appointment","text":"<p>Principais campos e suas fun\u00e7\u00f5es:</p> Campo Descri\u00e7\u00e3o SlotId Identifica o dia da consulta SelectedHour Hora espec\u00edfica (HourBox) escolhida ProfessionalTaxId M\u00e9dico/profissional respons\u00e1vel PatientTaxId CPF do paciente PatientAge / PatientGender Valida\u00e7\u00e3o autom\u00e1tica de idade e g\u00eanero HealthUnitTaxId Unidade de sa\u00fade onde a consulta ser\u00e1 realizada Status Estado da consulta (CONFIRMED, CANCELLED, NO_SHOW, etc.) TypeOfService Presencial, telemedicina ou home care RoomLink Link da sala virtual (para telemedicina) PaymentId Associa pagamento quando necess\u00e1rio IsCancelled / CancelledAt / CancelledByTaxId Controle de cancelamentos HasReschedule / WasRescheduled Controle de remarca\u00e7\u00f5es"},{"location":"5/#52-fluxo-de-agendamento","title":"5.2 Fluxo de Agendamento","text":""},{"location":"5/#passo-1-paciente-escolhe-especialidade-e-unidade","title":"Passo 1: Paciente escolhe especialidade e unidade","text":"<ul> <li>Exemplo: Maria quer pediatria no Hospital S\u00e3o Lucas.</li> <li>Sistema retorna dias com slots dispon\u00edveis e hor\u00e1rios (HourBoxes).</li> </ul>"},{"location":"5/#passo-2-selecao-do-slot-e-hora","title":"Passo 2: Sele\u00e7\u00e3o do slot e hora","text":"<ol> <li>Paciente escolhe o Slot (dia) desejado</li> <li> <p>Sistema lista HourBoxes dispon\u00edveis:</p> </li> <li> <p>AVAILABLE: pode marcar</p> </li> <li>BOOKED / HELD / BLOCKED / CANCELLED: n\u00e3o dispon\u00edvel</li> </ol> <p>Exemplo de retorno:</p> Hora Status Profissional dispon\u00edvel 08:00 AVAILABLE Dr. Carlos 08:30 AVAILABLE Dr. Carlos 09:00 BOOKED Dr. Carlos 09:30 BLOCKED Nenhum"},{"location":"5/#passo-3-validacao-de-regras-automaticas","title":"Passo 3: Valida\u00e7\u00e3o de regras autom\u00e1ticas","text":"<p>Antes de confirmar, o sistema verifica:</p> <ul> <li>Idade do paciente: compat\u00edvel com especialidade (ex: pediatria \u226418 anos)</li> <li>G\u00eanero do paciente: se houver restri\u00e7\u00e3o (ex: ginecologia s\u00f3 feminino)</li> <li>Hor\u00e1rio dispon\u00edvel: HourBox deve estar AVAILABLE</li> <li>Pagamento pendente: se consulta exigir pagamento antecipado</li> <li>Limite de cancelamento/remarca\u00e7\u00e3o: aplica pol\u00edticas de tempo m\u00ednimo</li> </ul> <p>Caso alguma regra falhe, o sistema retorna mensagem clara para o paciente.</p>"},{"location":"5/#passo-4-confirmacao-do-agendamento","title":"Passo 4: Confirma\u00e7\u00e3o do agendamento","text":"<ol> <li>Sistema cria o Appointment vinculado ao Slot e HourBox</li> <li>Atualiza HourBox.Status \u2192 BOOKED</li> <li>Se telemedicina, gera automaticamente RoomLink</li> <li>Notifica paciente e profissional via SMS/email</li> </ol> <p>Exemplo:</p> <ul> <li>Paciente: Jo\u00e3o Souza, 5 anos</li> <li>Especialidade: Pediatria</li> <li>Data: 20/04/2024</li> <li>Hora: 08:00</li> <li>Profissional: Dr. Carlos</li> </ul> <p>Resultado no sistema:</p> <ul> <li>Appointment.Status = CONFIRMED</li> <li>HourBox.Status = BOOKED</li> <li>RoomLink = null (presencial)</li> </ul>"},{"location":"5/#53-regras-de-cancelamento-e-remarcacao","title":"5.3 Regras de Cancelamento e Remarca\u00e7\u00e3o","text":""},{"location":"5/#531-cancelamento","title":"5.3.1 Cancelamento","text":"<ul> <li>Prazo m\u00ednimo: definido na Schedule (ex: 24h antes)</li> <li>A\u00e7\u00e3o: Atualiza Appointment.IsCancelled = true, HourBox.Status \u2192 AVAILABLE</li> <li>Multa: se cancelamento tardio, registra penalidade ou cobran\u00e7a autom\u00e1tica</li> </ul>"},{"location":"5/#532-remarcacao","title":"5.3.2 Remarca\u00e7\u00e3o","text":"<ul> <li>Paciente solicita remarca\u00e7\u00e3o</li> <li>Sistema verifica:</li> <li>Se j\u00e1 houve remarca\u00e7\u00e3o anterior (HasReschedule / WasRescheduled)</li> <li>Disponibilidade do novo slot/hora</li> <li>Limite de prazo para remarca\u00e7\u00e3o</li> <li>Se permitido:</li> <li>Novo Appointment \u00e9 criado, antigo marcado como remarcado</li> <li>HourBoxes atualizados: antigo \u2192 AVAILABLE, novo \u2192 BOOKED</li> </ul>"},{"location":"5/#54-exemplo-pratico-completo","title":"5.4 Exemplo Pr\u00e1tico Completo","text":""},{"location":"5/#cenario-consulta-de-telemedicina","title":"Cen\u00e1rio: Consulta de Telemedicina","text":"<ul> <li>Paciente: Ana Lima</li> <li>Especialidade: Cardiologia</li> <li>Data: 22/04/2024</li> <li>Hora: 14:00</li> <li>Tipo de servi\u00e7o: Telemedicina</li> <li>Profissional: Dr. Pedro</li> </ul> <p>Passos no sistema:</p> <ol> <li>Sistema verifica Slot (22/04) e HourBox (14:00)</li> <li>Confirma que Dr. Pedro est\u00e1 dispon\u00edvel (WorkingHour)</li> <li>Gera RoomLink: https://meet.hospital/xyz123</li> <li>Marca Appointment.Status = CONFIRMED</li> <li>Notifica paciente e Dr. Pedro</li> <li>15 minutos antes, envia SMS com RoomLink</li> </ol> <p>Se paciente tentar marcar fora do hor\u00e1rio:</p> <ul> <li>Hor\u00e1rio bloqueado ou indispon\u00edvel \u2192 mensagem de erro</li> <li>Sugere pr\u00f3ximos hor\u00e1rios dispon\u00edveis</li> </ul>"},{"location":"5/#55-consideracoes-importantes","title":"5.5 Considera\u00e7\u00f5es importantes","text":"<ul> <li>Appointment \u00e9 dependente do Slot e HourBox: sem dia e hora v\u00e1lidos, n\u00e3o \u00e9 poss\u00edvel marcar</li> <li>Valida\u00e7\u00f5es autom\u00e1ticas reduzem erros de agendamento</li> <li>Integra\u00e7\u00e3o com WorkingHour garante que apenas profissionais dispon\u00edveis sejam atribu\u00eddos</li> <li>Telemedicina e RoomLink s\u00e3o gerados automaticamente, sem necessidade de interven\u00e7\u00e3o manual</li> <li>Exclus\u00f5es e bloqueios aplicados antes do agendamento garantem consist\u00eancia e evitam conflitos</li> </ul>"},{"location":"6/","title":"6. Exclus\u00f5es de Dias e Per\u00edodos (ExcludeDay / ExcludeRange)","text":"<p>No sistema, nem todos os dias ou hor\u00e1rios de um slot podem estar dispon\u00edveis para marca\u00e7\u00e3o. Para gerenciar isso, usamos ExcludeDay (dias espec\u00edficos ou recorrentes) e ExcludeRange (per\u00edodos com hor\u00e1rio definido).</p> <p>Essas entidades garantem que feriados, reuni\u00f5es, f\u00e9rias ou eventos especiais n\u00e3o sejam acidentalmente agendados.</p>"},{"location":"6/#61-excludeday-bloqueio-de-dia-especifico-ou-recorrente","title":"6.1 ExcludeDay (Bloqueio de Dia Espec\u00edfico ou Recorrente)","text":""},{"location":"6/#estrutura-principal","title":"Estrutura principal","text":"Campo Descri\u00e7\u00e3o SpecificDate Data espec\u00edfica a ser bloqueada (ex: 07/09/2024) WeekDays Dias da semana a bloquear (ex: toda segunda-feira) TypeOfRecurrence Recorr\u00eancia: NONE, DAILY, WEEKLY, MONTHLY, ANNUALLY, CUSTOM ExclusionVisibility Quem v\u00ea/aplica a exclus\u00e3o: SYSTEM, HEALTH_UNIT, MEDICAL_AREA, SPECIALITY DefinedBy Usu\u00e1rio que definiu a exclus\u00e3o Title / Reason Nome e motivo da exclus\u00e3o (ex: Feriado, Reuni\u00e3o) IsActive Status da exclus\u00e3o (ativa ou n\u00e3o)"},{"location":"6/#611-exemplo-pratico-feriado-nacional","title":"6.1.1 Exemplo Pr\u00e1tico: Feriado Nacional","text":"<ul> <li>Bloquear 07/09/2024 (Independ\u00eancia do Brasil)</li> <li>Visibilidade: HEALTH_UNIT</li> <li>Usu\u00e1rio: administrador da unidade</li> </ul> <p>Resultado:</p> <ul> <li>Todos os slots deste dia ficam indispon\u00edveis</li> <li>Pacientes n\u00e3o conseguem marcar</li> <li>Profissionais recebem notifica\u00e7\u00e3o de bloqueio</li> </ul>"},{"location":"6/#612-exemplo-pratico-reuniao-semanal-da-equipe","title":"6.1.2 Exemplo Pr\u00e1tico: Reuni\u00e3o Semanal da Equipe","text":"<ul> <li>Bloqueio: Toda segunda-feira</li> <li>Hor\u00e1rio: 14:00 \u2013 15:00 (usa ExcludeRange tamb\u00e9m)</li> <li>Recorr\u00eancia: WEEKLY</li> <li>Motivo: \"Reuni\u00e3o da equipe\"</li> </ul> <p>Resultado:</p> <ul> <li>Sistema automaticamente bloqueia os hor\u00e1rios definidos</li> <li>N\u00e3o \u00e9 necess\u00e1rio criar manualmente todos os dias</li> </ul>"},{"location":"6/#62-excluderange-bloqueio-de-periodo-com-hora-especifica","title":"6.2 ExcludeRange (Bloqueio de Per\u00edodo com Hora Espec\u00edfica)","text":"<p>Enquanto o ExcludeDay bloqueia dias inteiros, o ExcludeRange permite bloquear hor\u00e1rios espec\u00edficos dentro de um dia ou per\u00edodo.</p>"},{"location":"6/#estrutura-principal_1","title":"Estrutura principal","text":"Campo Descri\u00e7\u00e3o StartTime / EndTime Hora de in\u00edcio e fim do bloqueio StartDate / EndDate Per\u00edodo de datas que se aplica ExcludeForAllSlots Se bloqueia todos os slots do dia ou apenas selecionados ExcludeFor / ExcludeForSpecificDates Dias da semana ou datas espec\u00edficas TypeOfRecurrence Recorr\u00eancia do bloqueio ExclusionVisibility Sistema, unidade, especialidade, etc. DefinedBy Usu\u00e1rio que criou a exclus\u00e3o Title / Reason Nome e motivo do bloqueio IsActive Status ativo ou inativo"},{"location":"6/#621-exemplo-pratico-bloqueio-de-ferias-de-profissional","title":"6.2.1 Exemplo Pr\u00e1tico: Bloqueio de F\u00e9rias de Profissional","text":"<ul> <li>Dra. Ana tira f\u00e9rias de 15/07 a 30/07</li> <li>Hor\u00e1rio: Todos os dias \u00fateis, 08:00 \u2013 18:00</li> <li>Tipo de exclus\u00e3o: ExclusionVisibility = SPECIALITY</li> <li> <p>Resultado:</p> </li> <li> <p>Slots e HourBoxes do per\u00edodo ficam bloqueados</p> </li> <li>Nenhuma consulta pode ser agendada para Dra. Ana</li> </ul>"},{"location":"6/#622-exemplo-pratico-manutencao-de-equipamento","title":"6.2.2 Exemplo Pr\u00e1tico: Manuten\u00e7\u00e3o de Equipamento","text":"<ul> <li>Unidade de vacina\u00e7\u00e3o ter\u00e1 manuten\u00e7\u00e3o da sala 10:00 \u2013 12:00</li> <li>Data: 25/04/2024</li> <li>ExclusionVisibility: HEALTH_UNIT</li> <li> <p>Resultado:</p> </li> <li> <p>HourBoxes deste per\u00edodo bloqueados</p> </li> <li>Pacientes n\u00e3o conseguem marcar nesse hor\u00e1rio</li> </ul>"},{"location":"6/#63-regras-de-aplicacao","title":"6.3 Regras de Aplica\u00e7\u00e3o","text":"<ol> <li> <p>Ordem de prioridade:</p> </li> <li> <p>ExcludeRange &gt; ExcludeDay &gt; Slot dispon\u00edvel</p> </li> <li> <p>Ou seja, se h\u00e1 bloqueio de per\u00edodo, mesmo que o dia esteja livre, n\u00e3o \u00e9 poss\u00edvel marcar</p> </li> <li> <p>Recorr\u00eancia autom\u00e1tica:</p> </li> <li> <p>ExcludeDay e ExcludeRange podem ser recorrentes (ex: toda segunda-feira, mensal, anual)</p> </li> <li> <p>O sistema gera automaticamente os bloqueios futuros</p> </li> <li> <p>Visibilidade:</p> </li> <li> <p>Define quem \u00e9 afetado pelo bloqueio:</p> <ul> <li>SYSTEM: aplica globalmente</li> <li>HEALTH_UNIT: aplica para toda a unidade</li> <li>MEDICAL_AREA: aplica a uma especialidade m\u00e9dica</li> <li>SPECIALITY: aplica apenas a agendas espec\u00edficas</li> </ul> </li> <li> <p>Integra\u00e7\u00e3o com Slots:</p> </li> <li> <p>Bloqueios n\u00e3o criam novas entidades de Slot</p> </li> <li>Eles marcam slots existentes como indispon\u00edveis para os hor\u00e1rios ou dias afetados</li> </ol>"},{"location":"6/#64-beneficio-pratico","title":"6.4 Benef\u00edcio Pr\u00e1tico","text":"<ul> <li>Evita agendamentos incorretos em feriados, reuni\u00f5es, f\u00e9rias ou manuten\u00e7\u00e3o</li> <li>Reduz conflitos manuais</li> <li>Permite planejamento automatizado, j\u00e1 que o sistema gera os bloqueios de acordo com a recorr\u00eancia e visibilidade</li> </ul>"},{"location":"7/","title":"7. Hor\u00e1rios de Trabalho dos Profissionais (WorkingHour)","text":"<p>O sistema permite que cada profissional tenha hor\u00e1rios de trabalho definidos por dia da semana, especialidade e unidade de sa\u00fade, permitindo planejar agendas e gerar slots autom\u00e1ticos de forma precisa.</p>"},{"location":"7/#71-estrutura-de-workinghour","title":"7.1 Estrutura de WorkingHour","text":"Campo Descri\u00e7\u00e3o ProfessionalTaxId Identificador do profissional (CPF) HealthUnitTaxId Unidade de sa\u00fade onde atua SpecialityCode C\u00f3digo da especialidade (ex: PED para Pediatria) WeekDay Dia da semana StartAt / EndsAt Hor\u00e1rio de in\u00edcio e fim do expediente ValidFrom / ValidTo Per\u00edodo de validade do hor\u00e1rio (ex: contrato tempor\u00e1rio, f\u00e9rias programadas) TypeOfService Tipo de atendimento: Presencial, Telemedicina ou Home ExcludedDays / ExcludedRanges Bloqueios aplicados ao profissional (feriados, folgas, f\u00e9rias)"},{"location":"7/#72-cadastro-de-horario-de-trabalho","title":"7.2 Cadastro de Hor\u00e1rio de Trabalho","text":""},{"location":"7/#exemplo-pratico-dra-ana-cardiologista","title":"Exemplo Pr\u00e1tico: Dra. Ana, Cardiologista","text":"<p>Objetivo: Configurar a rotina semanal de Dra. Ana na Unidade Hospitalar S\u00e3o Lucas.</p> Dia In\u00edcio Fim Tipo de servi\u00e7o Segunda 13:00 18:00 Presencial Ter\u00e7a 13:00 18:00 Presencial Quarta 13:00 18:00 Presencial Quinta 13:00 18:00 Presencial Sexta 13:00 18:00 Presencial S\u00e1bado 08:00 12:00 Presencial Domingo Folga - - <p>Configura\u00e7\u00e3o no sistema:</p> <ul> <li>Hor\u00e1rios cadastrados no WorkingHour</li> <li>Dias e horas bloqueados automaticamente em caso de f\u00e9rias, feriados ou eventos</li> </ul>"},{"location":"7/#73-integracao-com-slots","title":"7.3 Integra\u00e7\u00e3o com Slots","text":"<ul> <li>Cada Slot representa um dia completo dentro de uma agenda (n\u00e3o um hor\u00e1rio espec\u00edfico)</li> <li> <p>Ao criar uma agenda com recorr\u00eancia e hor\u00e1rio definido, o sistema verifica:</p> </li> <li> <p>Quais profissionais t\u00eam WorkingHour v\u00e1lidos naquele dia e hor\u00e1rio</p> </li> <li>Se existem Exclus\u00f5es aplicadas ao profissional (Ex: f\u00e9rias)</li> <li>O sistema atribui automaticamente os profissionais dispon\u00edveis aos slots gerados</li> <li> <p>Caso m\u00faltiplos profissionais possam atender, o sistema pode:</p> </li> <li> <p>Distribuir consultas de forma equilibrada</p> </li> <li>Permitir escolha manual (quando configurado)</li> </ul>"},{"location":"7/#74-exemplo-de-fluxo-de-atribuicao-automatica","title":"7.4 Exemplo de Fluxo de Atribui\u00e7\u00e3o Autom\u00e1tica","text":"<p>Cen\u00e1rio: Agenda de Pediatria, segunda-feira das 08:00 \u00e0s 12:00</p> <ol> <li>Sistema gera slot para 01/06/2024</li> <li> <p>Profissionais cadastrados com WorkingHour nesse hor\u00e1rio:</p> </li> <li> <p>Dr. Carlos (08:00-12:00)</p> </li> <li>Dra. Julia (08:00-12:00)</li> <li> <p>Sistema verifica exclus\u00f5es:</p> </li> <li> <p>Dr. Carlos est\u00e1 de folga \u2192 removido</p> </li> <li>Dra. Julia dispon\u00edvel \u2192 slot atribu\u00eddo</li> <li>Slot agora cont\u00e9m Dra. Julia como profissional dispon\u00edvel</li> <li>Quando paciente marca consulta, sistema cria HourBox no hor\u00e1rio escolhido dentro do slot</li> </ol>"},{"location":"7/#75-bloqueios-e-ajustes-dinamicos","title":"7.5 Bloqueios e Ajustes Din\u00e2micos","text":"<ul> <li> <p>Se um profissional adicionar uma folga ou sair de f\u00e9rias:</p> </li> <li> <p>ExcludeDay ou ExcludeRange associado a ele</p> </li> <li>Slots afetados perdem automaticamente o profissional</li> <li> <p>Consultas existentes podem:</p> <ul> <li>Ser remarcadas</li> <li>Receber notifica\u00e7\u00e3o de altera\u00e7\u00e3o</li> </ul> </li> <li> <p>Se um profissional altera hor\u00e1rio:</p> </li> <li> <p>O sistema atualiza automaticamente os slots futuros</p> </li> <li>Garantindo que nenhum hor\u00e1rio \u00e9 atribu\u00eddo fora da disponibilidade real</li> </ul>"},{"location":"7/#76-beneficios","title":"7.6 Benef\u00edcios","text":"<ul> <li>Precis\u00e3o: Apenas profissionais dispon\u00edveis s\u00e3o considerados</li> <li>Automa\u00e7\u00e3o: N\u00e3o \u00e9 necess\u00e1rio alocar manualmente cada consulta</li> <li>Flexibilidade: Hor\u00e1rios podem variar por dia, tipo de servi\u00e7o ou unidade</li> <li>Integra\u00e7\u00e3o total: Slots, agendas, exclus\u00f5es e consultas respeitam o hor\u00e1rio definido</li> </ul>"},{"location":"8/","title":"8. Slots e HourBoxes","text":"<p>No sistema, Slot e HourBox s\u00e3o conceitos distintos, mas interligados:</p> <ul> <li>Slot: representa um dia inteiro dentro de uma agenda, incluindo informa\u00e7\u00f5es sobre dia da semana, data espec\u00edfica, profissionais dispon\u00edveis e regras de agendamento.</li> <li>HourBox: representa cada hor\u00e1rio espec\u00edfico dispon\u00edvel dentro do Slot, onde os pacientes podem marcar consultas.</li> </ul> <p>Essa separa\u00e7\u00e3o permite flexibilidade, como definir diferentes dura\u00e7\u00f5es de consultas, capacidade por hor\u00e1rio e tipos de servi\u00e7o.</p>"},{"location":"8/#81-tipos-de-slots","title":"8.1 Tipos de Slots","text":"<p>Existem dois modos principais de opera\u00e7\u00e3o de slot:</p> Tipo Descri\u00e7\u00e3o Exemplo Timed (TEMPO FIXO) Cada HourBox representa um intervalo de tempo fixo (ex: 30 minutos). Agenda de Pediatria das 08:00 \u00e0s 12:00 com dura\u00e7\u00e3o de 30 minutos \u2192 gera HourBoxes: 08:00, 08:30, 09:00 \u2026 Capacity (CAPACIDADE) Cada hor\u00e1rio tem uma capacidade m\u00e1xima de pacientes, independente do tempo exato. Agenda de vacina\u00e7\u00e3o com 2 vagas por hor\u00e1rio: 08:00 (2 vagas), 08:30 (2 vagas) <p>Slots podem ser gerados automaticamente pela agenda ou criados manualmente se necess\u00e1rio.</p>"},{"location":"8/#82-geracao-automatica-de-slots","title":"8.2 Gera\u00e7\u00e3o Autom\u00e1tica de Slots","text":"<p>Ao criar uma agenda:</p> <ol> <li>Definir recorr\u00eancia: di\u00e1ria, semanal, mensal, personalizada</li> <li>Informar dias da semana e hor\u00e1rios de atendimento</li> <li>Sistema verifica hor\u00e1rios de trabalho dos profissionais (WorkingHour)</li> <li> <p>Para cada dia dentro do per\u00edodo da agenda:</p> </li> <li> <p>Cria um Slot</p> </li> <li>Atribui automaticamente profissionais dispon\u00edveis</li> <li>Cria HourBoxes para cada intervalo de tempo, com base no tipo de slot (Timed ou Capacity)</li> <li>Considera exclus\u00f5es (feriados, f\u00e9rias, folgas)</li> </ol> <p>Exemplo Pr\u00e1tico:</p> <p>Agenda de Pediatria (Dr. Carlos)</p> <ul> <li>Segunda a sexta, 08:00-12:00</li> <li>Dura\u00e7\u00e3o: 30 minutos</li> <li>Capacidade: 2 pacientes por hor\u00e1rio</li> </ul> <p>Sistema gera:</p> Slot (Data) HourBoxes 01/06/2024 08:00 (2 vagas), 08:30 (2 vagas), \u2026 11:30 (2 vagas) 02/06/2024 08:00 (2 vagas), 08:30 (2 vagas), \u2026 11:30 (2 vagas) \u2026 \u2026 <p>Se Dr. Carlos estiver de f\u00e9rias no dia 02/06/2024, slot desse dia n\u00e3o ter\u00e1 HourBoxes dispon\u00edveis.</p>"},{"location":"8/#83-exclusoes-e-bloqueios","title":"8.3 Exclus\u00f5es e Bloqueios","text":""},{"location":"8/#831-excludeday","title":"8.3.1 ExcludeDay","text":"<ul> <li>Bloqueia um dia inteiro</li> <li>Pode ser aplicado ao Slot ou a agendas espec\u00edficas</li> <li>Exemplo: 07/09/2024 \u00e9 feriado \u2192 nenhum HourBox dispon\u00edvel nesse Slot</li> </ul>"},{"location":"8/#832-excluderange","title":"8.3.2 ExcludeRange","text":"<ul> <li>Bloqueia intervalos dentro de um dia</li> <li>Exemplo: reuni\u00e3o da equipe segunda-feira 14:00-15:00</li> <li>Sistema ajusta os HourBoxes afetados \u2192 n\u00e3o podem ser marcados</li> </ul> <p>Ambos podem ter recorr\u00eancia (semanal, mensal, anual) e visibilidade (Sistema, Unidade, Especialidade)</p>"},{"location":"8/#84-atribuicao-automatica-de-profissionais","title":"8.4 Atribui\u00e7\u00e3o Autom\u00e1tica de Profissionais","text":"<ul> <li>Ao gerar slots, sistema verifica WorkingHours</li> <li> <p>Se mais de um profissional dispon\u00edvel:</p> </li> <li> <p>Pode distribuir pacientes de forma balanceada</p> </li> <li>Ou permitir sele\u00e7\u00e3o manual pelo paciente (dependendo da configura\u00e7\u00e3o da agenda)</li> <li>Se o profissional estiver bloqueado (Ex: folga), ele \u00e9 removido do Slot automaticamente</li> </ul>"},{"location":"8/#85-beneficios-do-sistema-de-slots","title":"8.5 Benef\u00edcios do Sistema de Slots","text":"<ul> <li>Automatiza\u00e7\u00e3o total: n\u00e3o precisa criar cada hor\u00e1rio manualmente</li> <li>Flexibilidade de capacidade: permite desde hor\u00e1rios individuais at\u00e9 grandes grupos (vacinas, exames)</li> <li>Integra\u00e7\u00e3o com exclus\u00f5es: feriados, f\u00e9rias e reuni\u00f5es ajustam os hor\u00e1rios automaticamente</li> <li>Seguran\u00e7a e previsibilidade: s\u00f3 profissionais dispon\u00edveis s\u00e3o atribu\u00eddos</li> </ul>"},{"location":"9/","title":"9. Marca\u00e7\u00e3o de Consultas (Appointments)","text":"<p>O Appointment \u00e9 a entidade central que conecta paciente, slot, profissional e regras da agenda. Cada agendamento representa uma consulta real que ser\u00e1 realizada presencialmente, por telemedicina ou em domic\u00edlio.</p>"},{"location":"9/#91-processo-de-marcacao","title":"9.1 Processo de Marca\u00e7\u00e3o","text":""},{"location":"9/#passo-1-paciente-seleciona-especialidade-e-unidade","title":"Passo 1: Paciente seleciona especialidade e unidade","text":"<ul> <li>Paciente acessa o sistema (web ou app)</li> <li> <p>Escolhe:</p> </li> <li> <p>Especialidade (ex: Pediatria)</p> </li> <li>Unidade de sa\u00fade (ex: Hospital S\u00e3o Lucas)</li> <li> <p>Sistema filtra slots dispon\u00edveis com base:</p> </li> <li> <p>Tipo de servi\u00e7o (presencial, telemedicina, home care)</p> </li> <li>Disponibilidade de profissionais</li> <li>Exclu\u00eddos por feriados/f\u00e9rias (ExcludeDay/ExcludeRange)</li> <li>Limites de capacidade e hor\u00e1rio</li> </ul>"},{"location":"9/#passo-2-escolha-de-slot-e-hourbox","title":"Passo 2: Escolha de Slot e HourBox","text":"<ul> <li>Sistema mostra slots de acordo com a agenda</li> <li> <p>Para cada slot, apresenta hourboxes dispon\u00edveis</p> </li> <li> <p>Indica n\u00famero de vagas restantes</p> </li> <li>Mostra se h\u00e1 restri\u00e7\u00f5es de g\u00eanero ou idade</li> <li> <p>Paciente seleciona hourbox desejada</p> </li> <li> <p>Exemplo: 08:30 do dia 01/06/2024</p> </li> </ul>"},{"location":"9/#passo-3-preenchimento-de-dados-do-paciente","title":"Passo 3: Preenchimento de dados do paciente","text":"<ul> <li>Nome, idade, g\u00eanero, CPF ou outro TaxId</li> <li>Telefone de contato</li> <li>Informa\u00e7\u00f5es adicionais (dependendo do tipo de consulta)</li> <li> <p>Sistema valida automaticamente:</p> </li> <li> <p>Idade compat\u00edvel com a especialidade</p> </li> <li>G\u00eanero permitido (ex: ginecologia somente mulheres)</li> <li>Limite de vagas do hourbox</li> <li>Pagamento necess\u00e1rio (PaymentId)</li> </ul>"},{"location":"9/#passo-4-confirmacao-e-bloqueio-do-hourbox","title":"Passo 4: Confirma\u00e7\u00e3o e bloqueio do hourbox","text":"<ul> <li> <p>Ao confirmar:</p> </li> <li> <p>HourBox passa para BOOKED</p> </li> <li>Consulta ganha status PENDING ou CONFIRMED, dependendo de pagamento</li> <li> <p>Sistema registra:</p> <ul> <li>Hor\u00e1rio e slot</li> <li>Profissional atribu\u00eddo</li> <li>Tipo de servi\u00e7o</li> <li>Data e hora de cria\u00e7\u00e3o</li> <li>Notifica\u00e7\u00f5es autom\u00e1ticas enviadas para paciente e profissional</li> </ul> </li> </ul>"},{"location":"9/#92-tipos-de-status-de-consulta","title":"9.2 Tipos de Status de Consulta","text":"Status Significado PENDING Consulta criada, aguardando confirma\u00e7\u00e3o/pagamento PENDING_FOR_PAYMENT Consulta aguardando pagamento PAYMENT_EXPIRED Pagamento n\u00e3o realizado dentro do prazo CONFIRMED Consulta confirmada CHECKED_IN Paciente chegou para consulta IN_SESSION Consulta em andamento COMPLETED Consulta realizada CANCELLED_BY_PATIENT Cancelamento pelo paciente CANCELLED_BY_PROFESSIONAL Cancelamento pelo profissional CANCELLED_BY_SYSTEM Cancelamento autom\u00e1tico por regras do sistema NO_SHOW Paciente n\u00e3o compareceu FOLLOW_UP_REQUIRED Necess\u00e1rio retorno ou acompanhamento DOCUMENT_PENDING Documentos ou exames pendentes EXPIRED Consulta expirada sem a\u00e7\u00e3o"},{"location":"9/#93-regras-automaticas","title":"9.3 Regras Autom\u00e1ticas","text":"<ul> <li>Idade e g\u00eanero: valida\u00e7\u00e3o autom\u00e1tica com base na agenda do slot</li> <li>Limite de vagas: n\u00e3o permite ultrapassar capacidade</li> <li>Cancelamento: apenas permitido se respeitar advanceCancellationInHours da agenda</li> <li>Remarca\u00e7\u00e3o: controla se HasReschedule ou WasRescheduled j\u00e1 foram usados</li> <li>Pagamento: consulta s\u00f3 passa para CONFIRMED ap\u00f3s pagamento, se necess\u00e1rio</li> <li>Telemedicina: sistema gera automaticamente roomLink e c\u00f3digo de acesso</li> </ul>"},{"location":"9/#94-exemplos-praticos","title":"9.4 Exemplos Pr\u00e1ticos","text":""},{"location":"9/#941-consulta-presencial","title":"9.4.1 Consulta Presencial","text":"<ul> <li>Paciente: Jo\u00e3o, 5 anos</li> <li>Agenda: Pediatria, Dr. Carlos</li> <li>Slot: 01/06/2024</li> <li>HourBox: 08:30 (2 vagas)</li> <li> <p>Processo:</p> </li> <li> <p>Jo\u00e3o seleciona 08:30</p> </li> <li>Sistema valida idade e g\u00eanero</li> <li>Confirma\u00e7\u00e3o \u2192 status CONFIRMED</li> <li>HourBox 08:30 agora tem 1 vaga restante</li> </ul>"},{"location":"9/#942-consulta-telemedicina","title":"9.4.2 Consulta Telemedicina","text":"<ul> <li>Paciente: Maria, adulta</li> <li>Agenda: Psicologia, Dra. Ana</li> <li>Tipo de servi\u00e7o: TELEMEDICINE</li> <li>Slot: 03/06/2024</li> <li>HourBox: 10:00</li> <li> <p>Sistema gera:</p> </li> <li> <p>Link da sala virtual: <code>https://meet.hospital/abc123</code></p> </li> <li>C\u00f3digo de acesso: <code>654321</code></li> <li>Notifica\u00e7\u00f5es enviadas 15 minutos antes</li> </ul>"},{"location":"9/#943-cancelamento-automatico-por-regras","title":"9.4.3 Cancelamento autom\u00e1tico por regras","text":"<ul> <li>Paciente tenta cancelar fora do prazo (menos que advanceCancellationInHours)</li> <li> <p>Sistema aplica regra:</p> </li> <li> <p>HourBox volta a AVAILABLE se cancelamento permitido</p> </li> <li>Caso contr\u00e1rio, marca NO_SHOW ou aplica multa</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/","title":"Contexto: Cria\u00e7\u00e3o/Actualiza\u00e7\u00e3o de Agenda","text":"<p>Todas as datas em UTC (ISO 8601). Padr\u00f5es: <code>page=1</code>, <code>limit=20</code>, <code>sortOrder=desc</code>. Autentica\u00e7\u00e3o: Bearer Token. Autoriza\u00e7\u00e3o: RBAC/ABAC conforme perfis.</p> <p>Este guia descreve tudo o que deve ser observado ao criar ou actualizar uma Agenda (<code>Schedules</code>). Inclui pr\u00e9-condi\u00e7\u00f5es, valida\u00e7\u00f5es, regras de neg\u00f3cio, padr\u00f5es de concorr\u00eancia, contratos de API, exemplos de payload, erros, auditoria, seguran\u00e7a, testes e boas pr\u00e1ticas.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#sumario","title":"Sum\u00e1rio","text":"<ul> <li>A. Objectivo do processo</li> <li>B. Pr\u00e9-condi\u00e7\u00f5es funcionais</li> <li>C. Mapeamento ao modelo (resumo)</li> <li>D. Valida\u00e7\u00f5es (camada de neg\u00f3cio)</li> <li>E. Regras de neg\u00f3cio (passo a passo)</li> <li>F. C\u00e1lculos derivados e pol\u00edticas</li> <li>G. Contratos de API (sugest\u00e3o)</li> <li>H. Concorr\u00eancia, transac\u00e7\u00f5es e integridade</li> <li>I. Auditoria e soft-delete</li> <li>J. Seguran\u00e7a, permiss\u00f5es e limites</li> <li>K. Erros padronizados (sugest\u00e3o)</li> <li>L. Exemplos adicionais (v\u00e1lidos e inv\u00e1lidos)</li> <li>M. Pseudo-c\u00f3digo do service (Create/Update)</li> <li>N. Testes (checklist)</li> <li>O. Boas pr\u00e1ticas e dicas finais</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#a-objectivo-do-processo","title":"A. Objectivo do processo","text":"<p>Criar/actualizar uma entidade Schedules que define:</p> <ul> <li>Janela di\u00e1ria de atendimento (in\u00edcio/fim).</li> <li>Recorr\u00eancia (NONE/DAILY/WEEKLY/\u2026/CUSTOM).</li> <li>Dias da semana activos.</li> <li>Vig\u00eancia (per\u00edodo de validade).</li> <li>Profissionais eleg\u00edveis.</li> <li>Pol\u00edticas de marca\u00e7\u00e3o/cancelamento.</li> <li>Gera\u00e7\u00e3o autom\u00e1tica de slots (opcional).</li> <li>Exclus\u00f5es (dias/intervalos) associadas a outras entidades.</li> <li>Compatibilidade total com fluxos de Slots, Exclus\u00f5es, Remarca\u00e7\u00f5es, Encaminhamentos e Relat\u00f3rios j\u00e1 definidos.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#b-pre-condicoes-funcionais","title":"B. Pr\u00e9-condi\u00e7\u00f5es funcionais","text":""},{"location":"GuiaDeConfiguracaoDaAgenda/#1-contexto-clinico-definido","title":"1) Contexto cl\u00ednico definido","text":"<ul> <li><code>healthUnitTaxId</code> (unidade) v\u00e1lido no ecossistema.</li> <li><code>specialityId</code> v\u00e1lido no cat\u00e1logo de especialidades.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#2-tempo-e-fuso-horario","title":"2) Tempo e fuso hor\u00e1rio","text":"<ul> <li>Backend e BD a trabalhar em UTC (<code>timestamptz</code>).</li> <li>Frontend converte para o fuso do utilizador apenas na apresenta\u00e7\u00e3o.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#3-parametros-minimos","title":"3) Par\u00e2metros m\u00ednimos","text":"<p>Conjunto m\u00ednimo de campos e regras para criar/actualizar uma agenda v\u00e1lida.</p> <ul> <li> <p><code>typeOfService</code> (obrigat\u00f3rio)   Valores: <code>IN_PERSON</code> | <code>TELEMEDICINE</code> | <code>HOME</code> Define o modo de atendimento (impacta UI e valida\u00e7\u00f5es como <code>roomLink</code> para telemedicina).</p> </li> <li> <p><code>typeOfSchedule</code> (obrigat\u00f3rio)   Valores: <code>CONSULTATION</code> | <code>VACCINE</code> | <code>EXAM</code> | <code>RETURN</code> Define o tipo de acto cl\u00ednico (pode activar pol\u00edticas espec\u00edficas).</p> </li> <li> <p>Janela di\u00e1ria (obrigat\u00f3ria) </p> </li> <li><code>startTime</code> &lt; <code>endTime</code> (ambos em <code>timestamptz</code>/UTC).  </li> <li> <p>Delimita o per\u00edodo di\u00e1rio onde se geram horas/slots.</p> </li> <li> <p>Vig\u00eancia (obrigat\u00f3ria em <code>startDate</code>; <code>endDate</code> opcional) </p> </li> <li><code>startDate</code> (UTC) \u2264 <code>endDate</code> (se informado).  </li> <li> <p>Define desde quando a agenda \u00e9 v\u00e1lida e, opcionalmente, at\u00e9 quando.</p> </li> <li> <p>Recorr\u00eancia &amp; dias activos </p> </li> <li><code>typeOfRecurrence</code> \u2260 <code>NONE</code> \u21d2 <code>weekDays.length \u2265 1</code>.  </li> <li> <p>Sem dias activos, n\u00e3o h\u00e1 repeti\u00e7\u00e3o semanal/mensal.</p> </li> <li> <p>Ritmo de marca\u00e7\u00e3o (XOR \u2014 escolher uma via) </p> </li> <li>Via A (por dura\u00e7\u00e3o): <code>appointmentDurationInMinutes</code> &gt; 0 Divide a janela di\u00e1ria em blocos fixos (ex.: 20/30 min). </li> <li>Via B (por capacidade): <code>maxAppointmentsPerSlot</code> \u2265 1 \u201cDia como slot\u201d ou overbooking controlado por limite.</li> </ul> <p>Fail-fast (valida\u00e7\u00f5es recomendadas): - Rejeitar se faltar <code>typeOfService</code> ou <code>typeOfSchedule</code>. - Rejeitar se <code>startTime &gt;= endTime</code>. - Rejeitar se <code>typeOfRecurrence \u2260 NONE</code> e <code>weekDays</code> estiver vazio. - Rejeitar se nem <code>appointmentDurationInMinutes</code> nem <code>maxAppointmentsPerSlot</code> forem fornecidos no mesmo pedido.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#4-capacidadetempo","title":"4) Capacidade/tempo","text":"<ul> <li>XOR obrigat\u00f3rio (escolher uma via):</li> <li> <p>Via A \u2014 por dura\u00e7\u00e3o: <code>appointmentDurationInMinutes</code> &gt; 0  </p> <ul> <li>Ex.: 30 \u2192 gera 08:00, 08:30, 09:00, \u2026 at\u00e9 <code>endTime</code>.  </li> <li>C\u00e1lculo: </li> <li><code>janela_util_min = endTime - startTime</code> (em minutos)  </li> <li><code>num_slots = floor(janela_util_min / appointmentDurationInMinutes)</code> </li> </ul> </li> <li> <p>Via B \u2014 por capacidade: <code>maxAppointmentsPerSlot</code> \u2265 1  </p> <ul> <li>\u00datil para \u201cdia como slot\u201d (sem grade por minutos) ou overbooking controlado.  </li> <li>Ex.: <code>maxAppointmentsPerSlot = 20</code> \u2192 at\u00e9 20 marca\u00e7\u00f5es distribu\u00eddas no dia.</li> </ul> </li> <li> <p>Deriva\u00e7\u00e3o (quando ambos vierem): </p> </li> <li>Se os dois forem enviados, dura\u00e7\u00e3o governa a gera\u00e7\u00e3o de hor\u00e1rios;  </li> <li> <p><code>maxAppointmentsPerSlot</code> funciona como limite por hor\u00e1rio (multi-atendimento).</p> </li> <li> <p>Valida\u00e7\u00f5es obrigat\u00f3rias: </p> </li> <li><code>startTime &lt; endTime</code> (sempre).  </li> <li><code>appointmentDurationInMinutes &gt; 0</code> (quando usado).  </li> <li><code>maxAppointmentsPerSlot \u2265 1</code> (quando usado).  </li> <li>Pelo menos um entre dura\u00e7\u00e3o e capacidade.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#erros-possiveis-e-codigos-recomendados","title":"Erros poss\u00edveis e c\u00f3digos recomendados","text":"C\u00f3digo Quando Exemplo de <code>errors[]</code> 400 Payload mal formado (tipos errados), campos desconhecidos, formato inv\u00e1lido. <code>{\"field\":\"appointmentDurationInMinutes\",\"message\":\"Must be an integer\"}</code> 401 Sem token ou sess\u00e3o inv\u00e1lida. <code>{\"message\":\"Unauthorized\"}</code> 403 Actor sem permiss\u00f5es para gerir a agenda da unidade. <code>{\"message\":\"Forbidden for healthUnitTaxId=540102938\"}</code> 404 Actualiza\u00e7\u00e3o de agenda inexistente. <code>{\"message\":\"Schedule not found\"}</code> 409 Regras mutuamente exclusivas violadas ou duplicidade l\u00f3gica. <code>{\"message\":\"Provide either appointmentDurationInMinutes OR maxAppointmentsPerSlot, not both null\"}</code> 409 Janela imposs\u00edvel para a dura\u00e7\u00e3o (ex.: 50 min numa janela de 45 min quando pol\u00edtica n\u00e3o permite o \u00faltimo slot parcial). <code>{\"message\":\"Duration does not fit within startTime/endTime under current policy\"}</code> 409 A altera\u00e7\u00e3o colide com slots/consultas j\u00e1 existentes (pol\u00edtica n\u00e3o-permissiva). <code>{\"message\":\"Existing appointments conflict with the new duration window\"}</code> 422 Regras de neg\u00f3cio falhadas (payload sint\u00e1ctico ok, mas inv\u00e1lido sem\u00e2ntico). <code>{\"field\":\"maxAppointmentsPerSlot\",\"message\":\"Must be &gt;= 1\"}</code> 422 Nenhuma via escolhida (dura\u00e7\u00e3o e capacidade ausentes). <code>{\"message\":\"Provide appointmentDurationInMinutes or maxAppointmentsPerSlot\"}</code> 422 <code>startTime &gt;= endTime</code>. <code>{\"message\":\"startTime must be before endTime\"}</code> 429 Protec\u00e7\u00e3o contra abuso/automa\u00e7\u00e3o (cria\u00e7\u00f5es em massa). <code>{\"message\":\"Rate limit exceeded. Try later.\"}</code> 500 Erro inesperado do servidor. <code>{\"message\":\"Internal error\",\"correlationId\":\"...\"}</code> <p>Exemplo (422 \u2014 XOR n\u00e3o cumprido) </p> <pre><code>{\n  \"message\": \"Provide appointmentDurationInMinutes or maxAppointmentsPerSlot\",\n  \"errors\": [\n    {\"field\":\"appointmentDurationInMinutes\",\"message\":\"Missing or invalid\"},\n    {\"field\":\"maxAppointmentsPerSlot\",\"message\":\"Missing or invalid\"}\n  ]\n}\n</code></pre>"},{"location":"GuiaDeConfiguracaoDaAgenda/#5-recorrencia-e-dias","title":"5) Recorr\u00eancia e dias","text":"<p>Define quando a agenda se repete (frequ\u00eancia) e em quais dias da semana \u00e9 v\u00e1lida. Regra principal: se <code>typeOfRecurrence</code> \u2260 <code>NONE</code>, ent\u00e3o <code>weekDays</code> deve conter pelo menos 1 dia.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#51-objectivo","title":"5.1 Objectivo","text":"<ul> <li>Determinar em que dias a janela di\u00e1ria (<code>startTime</code> \u2192 <code>endTime</code>) se aplica ao longo da vig\u00eancia (<code>startDate</code> \u2192 <code>endDate</code>).</li> <li>Controlar padr\u00f5es de repeti\u00e7\u00e3o (semanal, mensal, etc.) com base em <code>typeOfRecurrence</code> e, opcionalmente, regras avan\u00e7adas (RRULE noutros pontos do sistema).</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#52-comportamento-por-tipo-de-recorrencia","title":"5.2 Comportamento por tipo de recorr\u00eancia","text":"<ul> <li><code>NONE</code>: sem repeti\u00e7\u00e3o (slots apenas manuais). <code>weekDays</code> pode ser vazio.</li> <li><code>DAILY</code>: todos os dias na vig\u00eancia; <code>weekDays</code> opcional para restringir (ex.: dias \u00fateis).</li> <li><code>WEEKLY</code>: repete nos <code>weekDays</code> (obrigat\u00f3rio \u2265 1).</li> <li><code>MONTHLY/QUARTERLY/SEMIANNUALLY/ANNUALLY</code>: repeti\u00e7\u00e3o por per\u00edodos; pode delegar para RRULE.</li> <li><code>CUSTOM</code>: padr\u00f5es personalizados; preferir RRULE. Se n\u00e3o houver RRULE, aplicar valida\u00e7\u00f5es equivalentes.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#53-regras-e-validacoes-obrigatorias","title":"5.3 Regras e valida\u00e7\u00f5es obrigat\u00f3rias","text":"<ul> <li><code>typeOfRecurrence \u2260 NONE</code> \u21d2 <code>weekDays.length \u2265 1</code>.</li> <li><code>weekDays</code> \u2208 <code>SUNDAY..SATURDAY</code>, sem duplicados.</li> <li><code>startDate \u2264 endDate</code> (quando <code>endDate</code> existir).  </li> <li>Exclus\u00f5es t\u00eam prioridade sobre recorr\u00eancia (<code>ExcludeDay</code> &gt; <code>ExcludeRange</code>).</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#54-exemplos-e-erros","title":"5.4 Exemplos e erros","text":"<p>400 \u2014 <code>weekDays</code> inv\u00e1lido/duplicado  </p> <pre><code>{\n  \"message\": \"Invalid weekDays payload\",\n  \"errors\": [\n    { \"field\": \"weekDays[0]\", \"message\": \"Invalid enum value 'MONDEY'. Use SUNDAY..SATURDAY\" },\n    { \"field\": \"weekDays\", \"message\": \"Duplicate values are not allowed\" }\n  ]\n}\n</code></pre>"},{"location":"GuiaDeConfiguracaoDaAgenda/#c-mapeamento-ao-modelo","title":"C. Mapeamento ao modelo","text":"<pre><code>model Schedules {\n  id                            String                    @id @default(uuid())\n  healthUnitTaxId               String \n  specialityId                  String \n  weekDays                      WeekDays[]                @default([])\n  startTime                     DateTime                  @db.Timestamptz \n  endTime                       DateTime                  @db.Timestamptz \n  appointmentDurationInMinutes  Int? \n  maxAppointmentsPerSlot        Int?\n  typeOfRecurrence              TypeOfRecurrence \n  excludeRanges                 Schedules_ExcludeRange_[] @relation(\"Schedule\") \n  excludeDays                   Schedule_ExcludeDay_[]    @relation(\"Schedule\") \n  startDate                     DateTime                  @db.Timestamptz \n  endDate                       DateTime?                 @db.Timestamptz \n  typeOfSchedule                TypeOfSchedule \n  typeOfService                 TypeOfService \n  advanceCancellationInHours    Int? \n  deadlineForSlotBookingInHours Int? \n  availableProfessionalTaxIds   String[] \n  automaticallyGenerateSlots    Boolean \n  eachSlotInheritAllScheduleProfessionals Boolean @default(false)\n  applyGenderRestrictions GenderRestrictions @default(NONE)\n  autoPublishSlots          Boolean @default(false) \n  requireSupervisorApproval Boolean @default(true)\n  defaultPublishBufferHours Int? \n  defaultReviewTTLHours     Int?\n  createdBy    String \n  slots        Slots[]\n  appointments Appointment[]\n  createdAt    DateTime      @default(now()) @db.Timestamptz\n  updatedAt    DateTime      @updatedAt @db.Timestamptz\n  deletedAt    DateTime?\n\n  @@index([healthUnitTaxId, specialityId])\n  @@index([createdAt])\n  @@index([deletedAt])\n}\n</code></pre>"},{"location":"GuiaDeConfiguracaoDaAgenda/#d-validacoes-camada-de-negocio","title":"D. Valida\u00e7\u00f5es (camada de neg\u00f3cio)","text":"<p>Ordem recomendada: formatos \u2192 coer\u00eancia temporal \u2192 recorr\u00eancia/dias \u2192 capacidade \u2192 pol\u00edticas \u2192 seguran\u00e7a.</p> <p>1) Formatos - <code>healthUnitTaxId</code>, <code>specialityId</code>, <code>createdBy</code>: strings n\u00e3o vazias. - Listas (<code>weekDays</code>, <code>availableProfessionalTaxIds</code>) podem ser vazias, excepto quando regras obriguem. - Datas: ISO 8601, guardadas como timestamptz (UTC).</p> <p>2) Coer\u00eancia temporal - <code>startTime</code> &lt; <code>endTime</code>. - <code>endDate</code> (se existir): <code>startDate</code> \u2264 <code>endDate</code>. - <code>NONE</code> aceita <code>endDate</code> nulo.</p> <p>3) Recorr\u00eancia &amp; dias - <code>NONE</code> \u21d2 <code>weekDays</code> pode ser vazio. - <code>\u2260 NONE</code> \u21d2 <code>weekDays</code> obrigat\u00f3rio (\u2265 1, sem duplicados, enum v\u00e1lido).</p> <p>4) Capacidade/Tempo (XOR) - A) <code>appointmentDurationInMinutes</code> &gt; 0 OU - B) <code>maxAppointmentsPerSlot</code> \u2265 1. - Ambos presentes \u21d2 dura\u00e7\u00e3o governa; capacidade vira limite por hora (multi-atendimento).</p> <p>5) Pol\u00edticas - <code>deadlineForSlotBookingInHours</code> \u2265 0; <code>advanceCancellationInHours</code> \u2265 0 - (Recomendado) <code>advanceCancellationInHours</code> \u2265 <code>deadlineForSlotBookingInHours</code>.</p> <p>6) Profissionais - <code>availableProfessionalTaxIds</code>: lista de IDs externos (validar via micro-servi\u00e7o de utilizadores ou cache).</p> <p>7) Seguran\u00e7a/ACL - <code>createdBy</code> deve ter permiss\u00e3o para gerir agendas nessa unidade.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#e-regras-de-negocio-passo-a-passo","title":"E. Regras de neg\u00f3cio (passo a passo)","text":""},{"location":"GuiaDeConfiguracaoDaAgenda/#1-receber-pedido-createupdate-com-payload-json","title":"1) Receber pedido (Create/Update) com payload JSON","text":"<ul> <li>Validar <code>Content-Type: application/json</code>.</li> <li>Poss\u00edveis erros: <code>400/401/403/405/409/415</code> (detalhados acima).</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#2-normalizar-datashoras-para-utc","title":"2) Normalizar datas/horas para UTC","text":"<ul> <li>Converter tudo para UTC (armazenar em <code>timestamptz</code>).</li> <li>Erros: <code>400</code> (formato), <code>422</code> (coer\u00eancia).</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#3-validar-seccao-d-e-retornar-erros-agregados","title":"3) Validar (sec\u00e7\u00e3o D) e retornar erros agregados","text":"<ul> <li><code>400</code> (formato), <code>403</code> (ACL), <code>422</code> (regras).</li> <li>Boas pr\u00e1ticas: listar todos os erros em <code>errors[]</code>.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#4-coerencia-operacional-tabela-de-erros","title":"4) Coer\u00eancia operacional \u2014 Tabela de erros","text":"<p>(ver tabela j\u00e1 inclu\u00edda na tua vers\u00e3o consolidada)</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#5-persistir-a-agenda-transaccao-tabela-de-erros","title":"5) Persistir a Agenda (transac\u00e7\u00e3o) \u2014 Tabela de erros","text":"<p>(ver tabela j\u00e1 inclu\u00edda na tua vers\u00e3o consolidada)</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#6-geracao-automatica-de-slots-automaticallygenerateslots-true","title":"6) Gera\u00e7\u00e3o autom\u00e1tica de slots (<code>automaticallyGenerateSlots = true</code>)","text":"<ul> <li>Objectivo: criar Slots/horas conforme a Agenda + Exclus\u00f5es.</li> <li>Estrat\u00e9gia: preferir ass\u00edncrono com <code>operationId</code> (ver <code>/operations/{id}</code>).</li> <li>Idempot\u00eancia: chave <code>(scheduleId, from, to)</code>.</li> <li>Aplica\u00e7\u00e3o de exclus\u00f5es: <code>ExcludeDay</code> &gt; <code>ExcludeRange</code>.</li> <li>Upsert de Slots por <code>(scheduleId, specificDate)</code> sem apagar hist\u00f3rico.</li> </ul> <p>Pseudo-c\u00f3digo do worker (resumo)</p> <pre><code>async function generateSlotsJob({ scheduleId, from, to, correlationId }) {\n  // 1) Validar, garantir idempot\u00eancia e expandir recorr\u00eancia\n  // 2) Aplicar exclus\u00f5es (dia &gt; intervalo)\n  // 3) Construir grelha (via dura\u00e7\u00e3o ou via capacidade/dia)\n  // 4) Upsert idempotente de Slots e publicar m\u00e9tricas/eventos\n}\n</code></pre> <p>Tabelas de erros por fase: inclu\u00eddas na vers\u00e3o consolidada (A..F).</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#7-publicar-eventos-opcional","title":"7) Publicar eventos (opcional)","text":"<ul> <li><code>schedule.created</code>, <code>schedule.updated</code>, <code>schedule.slots.generated</code>, <code>schedule.slots.generation.failed</code>.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#f-calculos-derivados-e-politicas","title":"F. C\u00e1lculos derivados e pol\u00edticas","text":"<p>1) Capacidade derivada (quando h\u00e1 dura\u00e7\u00e3o) - <code>slots_por_dia = floor((end - start) / appointmentDurationInMinutes)</code> - <code>maxAppointmentsPerSlot</code> pode permitir multi-atendimento por hora.</p> <p>2) Validade da agenda - <code>NONE</code>: sem gera\u00e7\u00e3o por recorr\u00eancia; aceita slots manuais. - <code>WEEKLY/MONTHLY/...</code>: gera automaticamente conforme janela.</p> <p>3) Compatibilidade com exclus\u00f5es - Exclus\u00f5es consideradas na gera\u00e7\u00e3o e em tempo real na marca\u00e7\u00e3o.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#g-contratos-de-api","title":"G. Contratos de API","text":""},{"location":"GuiaDeConfiguracaoDaAgenda/#1-criar-agenda-post-schedules","title":"1) Criar Agenda \u2014 <code>POST /schedules</code>","text":"<p>Request (exemplo):</p> <pre><code>{\n  \"healthUnitTaxId\": \"540102938\",\n  \"specialityId\": \"CARDIOLOGY\",\n  \"weekDays\": [\"MONDAY\", \"WEDNESDAY\", \"FRIDAY\"],\n  \"startTime\": \"2025-11-01T08:00:00Z\",\n  \"endTime\": \"2025-11-01T16:00:00Z\",\n  \"appointmentDurationInMinutes\": 30,\n  \"maxAppointmentsPerSlot\": null,\n  \"typeOfRecurrence\": \"WEEKLY\",\n  \"startDate\": \"2025-11-01T00:00:00Z\",\n  \"endDate\": \"2026-01-31T00:00:00Z\",\n  \"typeOfSchedule\": \"CONSULTATION\",\n  \"typeOfService\": \"TELEMEDICINE\",\n  \"advanceCancellationInHours\": 12,\n  \"deadlineForSlotBookingInHours\": 2,\n  \"requireSupervisorApproval\": true,\n  \"autoPublishSlots\": false,\n  \"defaultPublishBufferHours\": 4,\n  \"defaultReviewTTLHours\": 24,\n  \"eachSlotInheritAllScheduleProfessionals\": true,\n  \"availableProfessionalTaxIds\": [\"BI12345\", \"BI67890\"],\n  \"automaticallyGenerateSlots\": true,\n  \"createdBy\": \"admin-user\"\n}\n</code></pre> <p>Responses: - 201 Created \u2014 corpo com recurso e <code>id</code> (+ <code>ETag</code>). - 400/409/415/422 \u2014 conforme tabelas. - Cabe\u00e7alhos: <code>ETag</code>, <code>Correlation-Id</code>.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#2-actualizar-agenda-putpatch-schedulesid","title":"2) Actualizar Agenda \u2014 <code>PUT/PATCH /schedules/{id}</code>","text":"<ul> <li>PATCH aceita campos parciais.</li> <li>Recomendar <code>If-Match</code> (ETag) para concorr\u00eancia optimista.</li> </ul> <p>Cuidados especiais no Update - Altera\u00e7\u00f5es estruturais (janela/dura\u00e7\u00e3o/recorr\u00eancia) n\u00e3o reescrevem slots passados. - Usar <code>effectiveFrom</code> para cortes futuros e endpoint dedicado para regenerar.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#h-concorrencia-transaccoes-e-integridade","title":"H. Concorr\u00eancia, transac\u00e7\u00f5es e integridade","text":"<ul> <li>Transac\u00e7\u00e3o ao persistir <code>Schedules</code>.</li> <li>Gera\u00e7\u00e3o de slots numa transac\u00e7\u00e3o separada (ou job ass\u00edncrono).</li> <li>\u00cdndices: j\u00e1 listados no modelo.</li> <li>Locks l\u00f3gicos para evitar jobs concorrentes na mesma janela.</li> </ul> <p>Invariantes - <code>startTime &lt; endTime</code>, <code>startDate \u2264 endDate</code>. - <code>typeOfRecurrence \u2260 NONE</code> \u21d2 <code>weekDays</code> n\u00e3o vazio. - Pelo menos um entre dura\u00e7\u00e3o e capacidade.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#i-auditoria-e-soft-delete","title":"I. Auditoria e soft-delete","text":"<ul> <li><code>createdAt</code>, <code>updatedAt</code> autom\u00e1ticos.</li> <li>Soft-delete: <code>deletedAt</code>.</li> <li>Listagens excluem <code>deletedAt != NULL</code> por omiss\u00e3o.</li> <li>Audit log (opcional): diffs antes/depois.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#j-seguranca-permissoes-e-limites","title":"J. Seguran\u00e7a, permiss\u00f5es e limites","text":"<ul> <li>ACL por <code>healthUnitTaxId</code> / papel do actor.</li> <li>Valida\u00e7\u00e3o cruzada de profissionais via micro-servi\u00e7o (com cache).</li> <li>Rate limit para evitar altera\u00e7\u00f5es em massa.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#k-erros-padronizados","title":"K. Erros padronizados","text":"C\u00f3digo Quando Corpo (exemplo) 400 Valida\u00e7\u00e3o falhou <code>{\"errors\":[{\"field\":\"startTime\",\"message\":\"startTime must be before endTime\"}]}</code> 401 N\u00e3o autenticado <code>{\"message\":\"Unauthorized\"}</code> 403 Sem permiss\u00e3o <code>{\"message\":\"Forbidden\"}</code> 404 Agenda n\u00e3o encontrada <code>{\"message\":\"Schedule not found\"}</code> 409 Conflito l\u00f3gico <code>{\"message\":\"A schedule with same unit/speciality and window already exists\"}</code> 500 Erro interno <code>{\"message\":\"Internal server error\",\"correlationId\":\"...\"}</code>"},{"location":"GuiaDeConfiguracaoDaAgenda/#l-exemplos-adicionais-validos-e-invalidos","title":"L. Exemplos adicionais (v\u00e1lidos e inv\u00e1lidos)","text":""},{"location":"GuiaDeConfiguracaoDaAgenda/#valido-agenda-dia-como-slot-sem-duracao","title":"\u2705 V\u00e1lido \u2014 Agenda \u201cdia como slot\u201d (sem dura\u00e7\u00e3o)","text":"<pre><code>{\n  \"healthUnitTaxId\": \"5002159961\",\n  \"specialityId\": \"DERMATOLOGY\",\n  \"weekDays\": [\"TUESDAY\", \"THURSDAY\"],\n  \"startTime\": \"2025-11-01T00:00:00Z\",\n  \"endTime\": \"2025-11-01T23:59:59Z\",\n  \"maxAppointmentsPerSlot\": 20,\n  \"typeOfRecurrence\": \"WEEKLY\",\n  \"startDate\": \"2025-11-01T00:00:00Z\",\n  \"typeOfSchedule\": \"CONSULTATION\",\n  \"typeOfService\": \"IN_PERSON\",\n  \"automaticallyGenerateSlots\": true,\n  \"createdBy\": \"ops\"\n}\n</code></pre>"},{"location":"GuiaDeConfiguracaoDaAgenda/#invalido-recorrencia-sem-dias","title":"\u274c Inv\u00e1lido \u2014 Recorr\u00eancia sem dias","text":"<pre><code>{\n  \"healthUnitTaxId\": \"5002159961\",\n  \"specialityId\": \"CARDIOLOGY\",\n  \"weekDays\": [],\n  \"startTime\": \"2025-11-01T08:00:00Z\",\n  \"endTime\": \"2025-11-01T16:00:00Z\",\n  \"appointmentDurationInMinutes\": 30,\n  \"typeOfRecurrence\": \"WEEKLY\",\n  \"startDate\": \"2025-11-01T00:00:00Z\",\n  \"typeOfSchedule\": \"CONSULTATION\",\n  \"typeOfService\": \"IN_PERSON\",\n  \"automaticallyGenerateSlots\": true,\n  \"createdBy\": \"ops\"\n}\n</code></pre> <p>Erro esperado: <code>400 \u2014 \"weekDays n\u00e3o pode ser vazio quando typeOfRecurrence \u2260 NONE\"</code>.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#invalido-nem-duracao-nem-capacidade","title":"\u274c Inv\u00e1lido \u2014 Nem dura\u00e7\u00e3o nem capacidade","text":"<pre><code>{\n  \"healthUnitTaxId\": \"5002159961\",\n  \"specialityId\": \"CARDIOLOGY\",\n  \"weekDays\": [\"MONDAY\"],\n  \"startTime\": \"2025-11-01T08:00:00Z\",\n  \"endTime\": \"2025-11-01T16:00:00Z\",\n  \"typeOfRecurrence\": \"WEEKLY\",\n  \"startDate\": \"2025-11-01T00:00:00Z\",\n  \"typeOfSchedule\": \"CONSULTATION\",\n  \"typeOfService\": \"IN_PERSON\",\n  \"automaticallyGenerateSlots\": true,\n  \"createdBy\": \"ops\"\n}\n</code></pre> <p>Erro esperado: <code>400 \u2014 \"Forne\u00e7a appointmentDurationInMinutes ou maxAppointmentsPerSlot\"</code>.</p>"},{"location":"GuiaDeConfiguracaoDaAgenda/#m-pseudo-codigo-do-service-createupdate","title":"M. Pseudo-c\u00f3digo do service (Create/Update)","text":"<pre><code>async function upsertSchedule(input, actor) {\n  normalizeToUTC(input); // startTime, endTime, startDate, endDate\n\n  // 1) Valida\u00e7\u00f5es\n  ensureNotEmpty(input.healthUnitTaxId, \"healthUnitTaxId\");\n  ensureNotEmpty(input.specialityId, \"specialityId\");\n  assert(input.startTime &lt; input.endTime, \"startTime must be before endTime\");\n  if (input.endDate) assert(input.startDate &lt;= input.endDate, \"startDate &lt;= endDate\");\n\n  const hasDuration = isPositiveInt(input.appointmentDurationInMinutes);\n  const hasCapacity = isPositiveInt(input.maxAppointmentsPerSlot);\n  assert(hasDuration || hasCapacity, \"duration OR capacity required\");\n\n  if (input.typeOfRecurrence !== \"NONE\") {\n    assert(input.weekDays &amp;&amp; input.weekDays.length &gt; 0, \"weekDays required for recurrence\");\n  }\n\n  checkPermissions(actor, input.healthUnitTaxId); // ACL\n\n  // 2) Persist\u00eancia (transa\u00e7\u00e3o)\n  return db.$transaction(async (tx) =&gt; {\n    const schedule = await tx.schedules.upsert({\n      where: { id: input.id ?? \"__none__\" },\n      create: {\n        ...input,\n        availableProfessionalTaxIds: input.availableProfessionalTaxIds ?? [],\n        createdBy: actor.id\n      },\n      update: { ...input }\n    });\n\n    // 3) Gera\u00e7\u00e3o de slots (opcional)\n    if (input.automaticallyGenerateSlots) {\n      await enqueueSlotGenerationJob(schedule.id, {\n        from: input.startDate,\n        to: input.endDate ?? addMonths(input.startDate, 2) // janela operacional\n      });\n    }\n\n    // 4) Evento (opcional)\n    await publish(\"schedule.updated\", { id: schedule.id });\n\n    return schedule;\n  });\n}\n</code></pre>"},{"location":"GuiaDeConfiguracaoDaAgenda/#n-testes","title":"N. Testes","text":"<ul> <li>Cria\u00e7\u00e3o v\u00e1lida com dura\u00e7\u00e3o (30 min).</li> <li>Cria\u00e7\u00e3o v\u00e1lida \u201cdia como slot\u201d (sem dura\u00e7\u00e3o, com capacidade).</li> <li>Actualiza\u00e7\u00e3o que altera apenas pol\u00edticas (deadlines) \u2014 n\u00e3o deve mexer em slots hist\u00f3ricos.</li> <li>Actualiza\u00e7\u00e3o de <code>weekDays</code> com <code>typeOfRecurrence \u2260 NONE</code> \u2014 v\u00e1lido.</li> <li>Erro: <code>startTime &gt;= endTime</code>.</li> <li>Erro: <code>typeOfRecurrence \u2260 NONE</code> e <code>weekDays = []</code>.</li> <li>Erro: sem dura\u00e7\u00e3o e sem capacidade.</li> <li>Timezone: guardar sempre timestamptz (UTC).</li> <li>Permiss\u00f5es: utilizador sem ACL n\u00e3o pode criar/alterar.</li> <li>Gera\u00e7\u00e3o autom\u00e1tica: ao activar, job \u00e9 agendado (ou executado) e slots s\u00e3o gerados.</li> <li>Compatibilidade: cria\u00e7\u00e3o/actualiza\u00e7\u00e3o n\u00e3o deve quebrar exclus\u00f5es existentes.</li> <li>Soft-delete: agendas marcadas em <code>deletedAt</code> n\u00e3o surgem por omiss\u00e3o.</li> </ul>"},{"location":"GuiaDeConfiguracaoDaAgenda/#o-boas-praticas-e-dicas-finais","title":"O. Boas pr\u00e1ticas e dicas finais","text":"<ul> <li>Separar \u201cdefini\u00e7\u00e3o\u201d da agenda da gera\u00e7\u00e3o de slots (job/servi\u00e7o dedicado).</li> <li>N\u00e3o reescrever slots passados ao actualizar a agenda (evita perda de hist\u00f3rico).</li> <li>Mensagens claras ao cliente: \u201cA agenda foi criada. Os hor\u00e1rios ser\u00e3o gerados automaticamente.\u201d</li> <li>Documentar pol\u00edticas locais: tempos de toler\u00e2ncia, feriados padr\u00e3o, janelas de gera\u00e7\u00e3o.</li> <li>Observabilidade: logs com <code>scheduleId</code>, <code>healthUnitTaxId</code>, <code>specialityId</code> e <code>correlationId</code>.</li> </ul> <p>Compatibilidade: Este guia j\u00e1 est\u00e1 alinhado com os m\u00f3dulos de Slots, Exclus\u00f5es, Relat\u00f3rios, Remarca\u00e7\u00f5es e Encaminhamentos, incluindo as pol\u00edticas de idempot\u00eancia, concorr\u00eancia (ETag/If-Match) e gera\u00e7\u00e3o ass\u00edncrona com <code>/operations/{id}</code>.</p>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/","title":"Guia de Slots \u2014 Implementa\u00e7\u00e3o (Marca\u00e7\u00e3o com hor\u00e1rios nos Slots)","text":"<p>Este documento descreve as regras, invariantes, formato do JSON <code>hours</code> e o fluxo de gera\u00e7\u00e3o/merge de horas para o modelo <code>Slots</code>, alinhado com o schema Prisma mais recente (inclui campos de visibilidade/publica\u00e7\u00e3o e aprova\u00e7\u00e3o).</p> <p>UTC sempre: todas as datas/horas devem ser <code>timestamptz</code> em UTC. Idempot\u00eancia: opera\u00e7\u00f5es de gera\u00e7\u00e3o/merge NUNCA devem apagar horas ocupadas (BOOKED/HELD) nem quebrar hist\u00f3rico. Pol\u00edticas: <code>ExcludeDay</code> tem prioridade sobre <code>ExcludeRange</code>.</p>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#modelo-prisma-slots-atualizado","title":"Modelo Prisma \u2014 Slots (atualizado)","text":"<pre><code>model Slots {\n  id                          String   @id @default(uuid())\n  inheritAllProfessionals     Boolean  @default(true)         // herda profissionais do Schedule?\n  availableProfessionalTaxIds String[] @default([])           // lista espec\u00edfica quando n\u00e3o herda\n  weekDay                     WeekDays                        // dia da semana em UTC\n  specificDate                DateTime @db.Timestamptz        // dia do slot (00:00:00Z)\n  markingLimit                Int                              // capacidade do dia\n  isClosed                    Boolean  @default(false)         // fechado (capacidade atingida)\n\n  genderRestriction GenderRestrictions @default(NONE)\n\n  scheduleId String\n  schedule   Schedules @relation(fields: [scheduleId], references: [id], onDelete: Restrict)\n\n  /**\n   * Estrutura JSON em `hours` (sempre UTC):\n   * [\n   *   {\n   *     \"hour\": \"2025-10-20T08:00:00Z\",\n   *     \"status\": \"AVAILABLE\" | \"HELD\" | \"BOOKED\" | \"CANCELLED\" | \"BLOCKED\",\n   *     \"appointmentId\": null,\n   *     \"professionalTaxId\": null,\n   *     \"roomLink\": null,\n   *     \"remarks\": null,\n   *     \"updatedAt\": \"2025-10-18T12:00:00Z\",\n   *     \"filledBy\": null\n   *   }\n   * ]\n   */\n  hours Json\n\n  appointments Appointment[]\n\n  // Publica\u00e7\u00e3o &amp; revis\u00e3o\n  visibility       SlotVisibility @default(DRAFT)  // DRAFT | PUBLISHED | REJECTED | ARCHIVED\n  approvalRequired Boolean        @default(true)   // exige aprova\u00e7\u00e3o?\n  submittedByTaxId String?                         // quem submeteu para revis\u00e3o\n  reviewedByTaxId  String?                         // quem aprovou/rejeitou\n  reviewedAt       DateTime?      @db.Timestamptz\n  publishAt        DateTime?      @db.Timestamptz  // quando foi/ser\u00e1 publicado\n  reviewNotes      String?\n\n  // Guardas de janela de publica\u00e7\u00e3o (opcionais)\n  publishNotBefore DateTime? @db.Timestamptz\n  publishExpiresAt DateTime? @db.Timestamptz\n\n  createdAt DateTime  @default(now()) @db.Timestamptz\n  updatedAt DateTime  @updatedAt @db.Timestamptz\n  deletedAt DateTime?\n\n  // \u00cdndices &amp; unicidade\n  @@unique([scheduleId, specificDate])\n  @@index([visibility, specificDate])\n  @@index([publishAt])\n  @@index([scheduleId, specificDate])\n  @@index([scheduleId, weekDay])\n  @@index([deletedAt])\n}\n</code></pre> <p>Nota: mantenha o par \u00fanico <code>@@unique([scheduleId, specificDate])</code> para garantir um slot por dia para cada agenda.</p>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#1-invariantes-recomendados","title":"1) Invariantes Recomendados","text":"<ul> <li>Unicidade (um dia por agenda): <code>@@unique([scheduleId, specificDate])</code> </li> <li>UTC Sempre: <code>specificDate</code> e <code>hours[i].hour</code> em UTC  </li> <li><code>markingLimit</code> consistente:</li> <li>Via A (grelha por dura\u00e7\u00e3o): capacidade = <code>#timeboxes \u00d7 (multi-atendimento opcional)</code> </li> <li>Via B (dia-como-slot): capacidade = <code>maxAppointmentsPerSlot</code> do Schedule</li> <li>Fecho autom\u00e1tico: <code>isClosed = true</code> quando capacidade atingida / todas as boxes ocupadas</li> <li>Heran\u00e7a de profissionais: <code>inheritAllProfessionals = true</code> \u2192 usar <code>schedule.availableProfessionalTaxIds</code></li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#2-esquema-do-json-hours","title":"2) Esquema do JSON <code>hours</code>","text":"<pre><code>[\n  {\n    \"hour\": \"2025-10-20T08:00:00Z\",\n    \"status\": \"AVAILABLE\",\n    \"isFilled\": false,\n    \"appointmentId\": null,\n    \"professionalTaxId\": null,\n    \"roomLink\": null,\n    \"remarks\": null,\n    \"updatedAt\": \"2025-10-18T12:00:00Z\",\n    \"filledBy\": null\n  }\n]\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#derivacao-sugerida-de-isfilled-a-partir-de-status","title":"Deriva\u00e7\u00e3o sugerida de <code>isFilled</code> a partir de <code>status</code>","text":"status isFilled AVAILABLE false HELD true BOOKED true CANCELLED false BLOCKED true"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#3-geracao-merge-de-horas","title":"3) Gera\u00e7\u00e3o &amp; MERGE de horas","text":""},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#31-principios","title":"3.1 Princ\u00edpios","text":"<ul> <li>NUNCA sobrescrever/remover horas BOOKED/HELD/BLOCKED </li> <li>Adicionar novas horas quando a grelha aumentar  </li> <li>Remover apenas horas AVAILABLE/CANCELLED que ficaram fora do novo c\u00e1lculo  </li> <li>UTC em toda a pipeline</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#32-tiposhelpers-typescript","title":"3.2 Tipos/Helpers (TypeScript)","text":"<pre><code>type HourBox = {\n  hour: string; // ISO UTC\n  status: 'AVAILABLE'|'HELD'|'BOOKED'|'CANCELLED'|'BLOCKED';\n  appointmentId?: string|null;\n  professionalTaxId?: string|null;\n  roomLink?: string|null;\n  remarks?: string|null;\n  updatedAt?: string;\n  filledBy?: string|null;\n};\n\n/** Merge idempotente &amp; seguro */\nfunction mergeHoursSafely(existing: HourBox[], incoming: HourBox[]): HourBox[] {\n  const byKey = new Map(existing.map(h =&gt; [h.hour, h]));\n  for (const h of incoming) {\n    const cur = byKey.get(h.hour);\n    if (!cur) { byKey.set(h.hour, h); continue; }\n    const occupied = ['BOOKED','HELD','BLOCKED'].includes(cur.status);\n    if (occupied) continue;\n    byKey.set(h.hour, { ...cur, ...h, updatedAt: new Date().toISOString() });\n  }\n  const incomingSet = new Set(incoming.map(h =&gt; h.hour));\n  return Array.from(byKey.values()).filter(h =&gt; {\n    const keepOccupied = ['BOOKED','HELD','BLOCKED'].includes(h.status);\n    if (keepOccupied) return true;\n    return incomingSet.has(h.hour);\n  });\n}\n\n/** Projeta HH:mm:ss do Schedule numa data espec\u00edfica (UTC) */\nfunction projectScheduleTimeToDate(scheduleTimeUtc: Date, dayUtc: Date) {\n  return new Date(Date.UTC(\n    dayUtc.getUTCFullYear(),\n    dayUtc.getUTCMonth(),\n    dayUtc.getUTCDate(),\n    scheduleTimeUtc.getUTCHours(),\n    scheduleTimeUtc.getUTCMinutes(),\n    scheduleTimeUtc.getUTCSeconds()\n  ));\n}\n\n/** Grelha via dura\u00e7\u00e3o (Via A) */\nfunction buildHoursGrid(schedule: {\n  startTime: string | Date;\n  endTime: string | Date;\n  appointmentDurationInMinutes: number;\n}, dayUtc: Date): HourBox[] {\n  if (!schedule.appointmentDurationInMinutes || schedule.appointmentDurationInMinutes &lt;= 0) {\n    throw new Error('buildHoursGrid requer appointmentDurationInMinutes &gt; 0');\n  }\n  const start = projectScheduleTimeToDate(new Date(schedule.startTime), dayUtc);\n  const end   = projectScheduleTimeToDate(new Date(schedule.endTime), dayUtc);\n  if (+end &lt;= +start) throw new Error('startTime deve ser anterior a endTime');\n\n  const stepMs = Math.floor(schedule.appointmentDurationInMinutes) * 60_000;\n  const out: HourBox[] = [];\n  for (let t = +start; t &lt; +end; t += stepMs) {\n    out.push({ hour: new Date(t).toISOString(), status: 'AVAILABLE', appointmentId: null, professionalTaxId: null, updatedAt: new Date().toISOString() });\n  }\n  return out;\n}\n\n/** Grelha via capacidade (Via B \u2014 dia como slot) */\nfunction buildCapacityBoxes(schedule: { maxAppointmentsPerSlot?: number|null }, dayUtc: Date): HourBox[] {\n  const cap = schedule.maxAppointmentsPerSlot &amp;&amp; schedule.maxAppointmentsPerSlot &gt; 0 ? schedule.maxAppointmentsPerSlot : 1;\n  const base = new Date(Date.UTC(dayUtc.getUTCFullYear(), dayUtc.getUTCMonth(), dayUtc.getUTCDate(), 0, 0, 0));\n  return Array.from({ length: cap }, (_, i) =&gt; ({\n    hour: new Date(+base + i).toISOString(),\n    status: 'AVAILABLE',\n    appointmentId: null,\n    professionalTaxId: null,\n    updatedAt: new Date().toISOString()\n  }));\n}\n\n/** Exclus\u00f5es (stub) \u2014 aplicar ExcludeDay &gt; ExcludeRange */\nfunction applyExcludeRanges(baseHours: HourBox[], excludeRanges: any[], dayUtc: Date): HourBox[] {\n  // Implementar conforme pol\u00edticas locais:\n  // - Remover/recortar janelas (12:00\u201313:00) e datas pontuais\n  // - Honrar RRULE\n  // - Nunca remover BOOKED/HELD; marcar como BLOCKED se necess\u00e1rio\n  return baseHours;\n}\n\n/** Capacidade &amp; fecho */\nfunction deriveMarkingLimit(schedule: any, hours: HourBox[]): number {\n  if (typeof schedule.maxAppointmentsPerSlot === 'number' &amp;&amp; schedule.maxAppointmentsPerSlot &gt; 0) return schedule.maxAppointmentsPerSlot;\n  return hours.length;\n}\nfunction inferCapacityFromGrid(hours: HourBox[]): number { return hours.length; }\nfunction countFilled(hours: HourBox[]): number { return hours.filter(h =&gt; ['BOOKED','HELD'].includes(h.status)).length; }\nfunction allTimeBoxesFilled(hours: HourBox[]): boolean { return hours.every(h =&gt; ['BOOKED','HELD','BLOCKED'].includes(h.status)); }\nfunction weekday(d: Date): 'SUNDAY'|'MONDAY'|'TUESDAY'|'WEDNESDAY'|'THURSDAY'|'FRIDAY'|'SATURDAY' {\n  return ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'][d.getUTCDay()] as any;\n}\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#4-upsert-idempotente-do-slot-por-dia","title":"4) Upsert idempotente do Slot (por dia)","text":"<pre><code>async function upsertSlotDay({\n  prisma,\n  schedule,\n  dateUtc,\n  inheritAll\n}: {\n  prisma: any; // PrismaClient\n  schedule: {\n    id: string;\n    startTime: string | Date;\n    endTime: string | Date;\n    appointmentDurationInMinutes?: number | null;\n    maxAppointmentsPerSlot?: number | null;\n    availableProfessionalTaxIds?: string[] | null;\n    excludeRanges?: any[];\n  };\n  dateUtc: Date;\n  inheritAll: boolean;\n}) {\n  const usesDuration = !!schedule.appointmentDurationInMinutes &amp;&amp; schedule.appointmentDurationInMinutes &gt; 0;\n  const baseHours = usesDuration\n    ? buildHoursGrid(schedule as any, dateUtc)\n    : buildCapacityBoxes(schedule as any, dateUtc);\n\n  const hoursAfterExclude = applyExcludeRanges(baseHours, schedule.excludeRanges ?? [], dateUtc);\n\n  const existing = await prisma.slots.findUnique({\n    where: { scheduleId_specificDate: { scheduleId: schedule.id, specificDate: dateUtc } }\n  });\n\n  const base = existing ?? {\n    scheduleId: schedule.id,\n    specificDate: dateUtc,\n    weekDay: weekday(dateUtc),\n    inheritAllProfessionals: inheritAll,\n    availableProfessionalTaxIds: inheritAll ? (schedule.availableProfessionalTaxIds ?? []) : [],\n    markingLimit: deriveMarkingLimit(schedule as any, hoursAfterExclude),\n    isClosed: false,\n    hours: [] as HourBox[]\n  };\n\n  const merged = mergeHoursSafely(base.hours as HourBox[], hoursAfterExclude);\n  const capacity = base.markingLimit ?? inferCapacityFromGrid(merged);\n  const isClosed = countFilled(merged) &gt;= capacity || allTimeBoxesFilled(merged);\n\n  if (existing) {\n    await prisma.slots.update({\n      where: { id: existing.id },\n      data: {\n        hours: merged,\n        isClosed,\n        availableProfessionalTaxIds: base.inheritAllProfessionals\n          ? (schedule.availableProfessionalTaxIds ?? [])\n          : base.availableProfessionalTaxIds\n      }\n    });\n    return existing.id;\n  }\n\n  const created = await prisma.slots.create({ data: { ...base, hours: merged, isClosed } });\n  return created.id;\n}\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#5-exclusoes","title":"5) Exclus\u00f5es","text":"<p>Prioridade: <code>ExcludeDay &gt; ExcludeRange</code> - <code>ExcludeDay</code> \u2192 remove o dia inteiro - <code>ExcludeRange</code> \u2192 corta/remarca intervalos</p> <p>Regra de ouro: - <code>BOOKED/HELD</code> \u2192 nunca remover - <code>AVAILABLE/CANCELLED</code> \u2192 podem ser removidos ou marcados como <code>BLOCKED</code></p>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#6-validacoes-rapidas","title":"6) Valida\u00e7\u00f5es r\u00e1pidas","text":"<ul> <li><code>specificDate</code> em UTC  </li> <li><code>weekDay === weekday(specificDate)</code> </li> <li><code>inheritAllProfessionals = true</code> \u2192 ignorar <code>availableProfessionalTaxIds</code> do payload  </li> <li><code>hours[*].hour</code> sem duplicados e sempre ISO-8601 UTC </li> <li>Em reserva, validar se <code>professionalTaxId</code> pertence \u00e0 lista herdada ou espec\u00edfica do slot</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#7-indices-e-constraints","title":"7) \u00cdndices e Constraints","text":"<pre><code>@@unique([scheduleId, specificDate])\n@@index([visibility, specificDate])\n@@index([publishAt])\n@@index([scheduleId, specificDate])\n@@index([scheduleId, weekDay])\n@@index([deletedAt])\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#8-fluxo-de-reserva","title":"8) Fluxo de Reserva","text":"<ol> <li>Selecionar <code>hour</code> no JSON do Slot  </li> <li>Validar <code>status === 'AVAILABLE'</code> e autoriza\u00e7\u00e3o do profissional  </li> <li>Criar <code>Appointment</code> e atualizar <code>hours[i]</code> (<code>status \u2192 BOOKED</code>, <code>appointmentId</code>)  </li> <li>Atualizar <code>isClosed</code> conforme capacidade  </li> <li>Em conflito \u2192 <code>409 Conflict</code></li> </ol>"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#9-erros-comuns-e-codigos","title":"9) Erros Comuns e C\u00f3digos","text":"Situa\u00e7\u00e3o C\u00f3digo Mensagem Duplicar slot no mesmo dia/agenda 409 Slot for this schedule and date already exists <code>hours[*].hour</code> inv\u00e1lido ou n\u00e3o UTC 422 hours[*].hour must be ISO-8601 UTC Misturar Via A e Via B 422 Provide appointmentDurationInMinutes or maxAppointmentsPerSlot Remover hora com marca\u00e7\u00e3o/hold 409 Cannot remove booked/held hour Profissional n\u00e3o autorizado 403 Professional not allowed for this slot <code>weekDay</code> n\u00e3o corresponde a <code>specificDate</code> 422 weekDay must match specificDate Falha de idempot\u00eancia/concurrency 409 Slot generation already in progress"},{"location":"GuiadegeracaodeSlotsFormaA-horarios/#10-checklist-de-testes","title":"10) Checklist de Testes","text":"<ul> <li>Gera\u00e7\u00e3o Via A (dura\u00e7\u00e3o) e Via B (capacidade)  </li> <li>Merge preserva BOOKED/HELD/BLOCKED </li> <li>Exclus\u00f5es respeitam ExcludeDay &gt; ExcludeRange </li> <li>Proje\u00e7\u00e3o UTC correta em virada de m\u00eas/ano  </li> <li>Heran\u00e7a de profissionais (on/off)  </li> <li><code>isClosed</code> liga/desliga conforme capacidade  </li> <li>Reserva concorrente \u2192 <code>409 Conflict</code> </li> <li>Soft-delete n\u00e3o afeta consultas hist\u00f3ricas</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/","title":"Regras claras de \u201cmodo capacidade\u201d (sem hor\u00e1rios)","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#deteccao-do-modo","title":"Detec\u00e7\u00e3o do modo","text":"Modo Condi\u00e7\u00e3o hours TIMED (com hor\u00e1rios) <code>appointmentDurationInMinutes &gt; 0</code> preenchido CAPACITY (sem hor\u00e1rios) <code>appointmentDurationInMinutes == null</code> e <code>maxAppointmentsPerSlot &gt; 0</code> <code>[]</code> (vazio)"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#geracao-de-slots","title":"Gera\u00e7\u00e3o de Slots","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#em-capacity","title":"Em CAPACITY:","text":"<ul> <li><code>slots.hours = []</code> (array vazio)</li> <li><code>slots.markingLimit = schedules.maxAppointmentsPerSlot</code></li> <li><code>slots.isClosed = (totalAppointmentsDoDia &gt;= markingLimit)</code></li> <li><code>inheritAllProfessionals</code> continua a funcionar (valida\u00e7\u00e3o de quem pode atender)</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#reservas-appointment","title":"Reservas (Appointment)","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#em-capacity_1","title":"Em CAPACITY:","text":"<ul> <li><code>Appointment.selectedHour = null</code></li> <li>Obrigat\u00f3rios:</li> <li><code>slotId</code></li> <li><code>patientTaxId</code></li> <li><code>professionalTaxId</code></li> <li><code>typeOfService</code></li> </ul> <p>A l\u00f3gica de capacidade \u00e9 por contagem de appointments do slot.</p> <p><code>@@unique([slotId, selectedHour, professionalTaxId])</code> n\u00e3o bloqueia (NULL em Postgres n\u00e3o conflita).</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#invariantes","title":"Invariantes","text":"<p>Se a agenda estiver em CAPACITY:</p> <ul> <li><code>slots.hours</code> deve estar vazio (n\u00e3o gerar timeboxes)</li> <li><code>markingLimit &gt; 0</code></li> <li>Ao criar appointment \u2192 n\u00e3o ultrapassar o markingLimit</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#ajustes-no-servico-geracao-e-reserva","title":"Ajustes no servi\u00e7o (gera\u00e7\u00e3o e reserva)","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#a-geracao-de-slot-capacity","title":"A) Gera\u00e7\u00e3o de Slot (CAPACITY)","text":"<pre><code>/**\n * Fun\u00e7\u00e3o respons\u00e1vel por gerar (ou atualizar) um Slot di\u00e1rio no modo CAPACITY.\n * Esse modo n\u00e3o possui hor\u00e1rios (hours = []), apenas um limite de marca\u00e7\u00f5es por dia.\n */\nasync function upsertSlotDay_Capacity({\n  prisma,\n  schedule,\n  dateUtc,\n  inheritAll\n}: {\n  prisma: any; // Inst\u00e2ncia do Prisma para acesso ao banco de dados\n  schedule: {\n    id: string;                         // ID da agenda (schedule)\n    maxAppointmentsPerSlot: number;     // Limite m\u00e1ximo de marca\u00e7\u00f5es por slot (capacidade)\n    availableProfessionalTaxIds?: string[]; // Lista de profissionais permitidos (opcional)\n  };\n  dateUtc: Date;       // Data do dia que se deseja criar/atualizar o slot\n  inheritAll: boolean; // Se verdadeiro, o slot herda todos os profissionais da agenda\n}) {\n  // 1\ufe0f\u20e3 No modo CAPACITY, n\u00e3o h\u00e1 hor\u00e1rios \u2014 apenas um array vazio.\n  const hours: any[] = [];\n\n  // 2\ufe0f\u20e3 O limite de marca\u00e7\u00f5es (capacidade) vem diretamente da agenda.\n  const markingLimit = schedule.maxAppointmentsPerSlot;\n\n  // 3\ufe0f\u20e3 Verifica se j\u00e1 existe um Slot criado para essa agenda e data espec\u00edfica.\n  //    A busca usa um \u00edndice composto (scheduleId + specificDate).\n  const existing = await prisma.slots.findUnique({\n    where: { scheduleId_specificDate: { scheduleId: schedule.id, specificDate: dateUtc } }\n  });\n\n  // 4\ufe0f\u20e3 Define os dados base para cria\u00e7\u00e3o (ou atualiza\u00e7\u00e3o) do Slot.\n  //    - `inheritAllProfessionals`: indica se o slot herda todos os profissionais da agenda.\n  //    - `availableProfessionalTaxIds`: lista de profissionais v\u00e1lidos (ou vazia).\n  //    - `markingLimit`: capacidade m\u00e1xima de marca\u00e7\u00f5es por dia.\n  //    - `isClosed`: indica se o slot est\u00e1 cheio (por padr\u00e3o come\u00e7a como false).\n  //    - `hours`: vazio (pois modo CAPACITY n\u00e3o possui timeboxes).\n  const baseData = {\n    scheduleId: schedule.id,\n    specificDate: dateUtc,\n    weekDay: weekday(dateUtc), // Converte a data para dia da semana (MONDAY, TUESDAY, etc.)\n    inheritAllProfessionals: inheritAll,\n    availableProfessionalTaxIds: inheritAll ? (schedule.availableProfessionalTaxIds ?? []) : [],\n    markingLimit,\n    isClosed: false,\n    hours\n  };\n\n  // 5\ufe0f\u20e3 Caso j\u00e1 exista um Slot para o mesmo dia...\n  if (existing) {\n    // 5.1\ufe0f\u20e3 Conta quantos appointments (marca\u00e7\u00f5es) existem nesse slot.\n    //      Marca\u00e7\u00f5es deletadas (deletedAt != null) n\u00e3o contam.\n    const count = await prisma.appointment.count({ where: { slotId: existing.id, deletedAt: null } });\n\n    // 5.2\ufe0f\u20e3 Verifica se a capacidade foi atingida.\n    const isClosed = count &gt;= (existing.markingLimit ?? markingLimit);\n\n    // 5.3\ufe0f\u20e3 Atualiza o Slot existente com os novos dados.\n    //      - Garante que `hours` fique vazio.\n    //      - Atualiza o `markingLimit` e `isClosed`.\n    //      - Atualiza a lista de profissionais dispon\u00edveis (se herdar da agenda).\n    await prisma.slots.update({\n      where: { id: existing.id },\n      data: {\n        hours, // limpa poss\u00edveis hor\u00e1rios antigos (caso tenha mudado de modo TIMED \u2192 CAPACITY)\n        markingLimit,\n        isClosed,\n        availableProfessionalTaxIds: baseData.inheritAllProfessionals\n          ? (schedule.availableProfessionalTaxIds ?? [])\n          : existing.availableProfessionalTaxIds\n      }\n    });\n\n    // 5.4\ufe0f\u20e3 Retorna o ID do Slot atualizado.\n    return existing.id;\n  }\n\n  // 6\ufe0f\u20e3 Caso o Slot ainda n\u00e3o exista:\n  //     Cria um novo registro com base nos dados preparados.\n  const created = await prisma.slots.create({ data: baseData });\n\n  // 7\ufe0f\u20e3 Retorna o ID do Slot rec\u00e9m-criado.\n  return created.id;\n}\n\n/**\n * Fun\u00e7\u00e3o auxiliar que converte uma data UTC para o nome do dia da semana.\n * Exemplo: segunda \u2192 \"MONDAY\"\n */\nfunction weekday(d: Date) {\n  return ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'][d.getUTCDay()];\n}\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#funcao-upsertslotday_capacity","title":"Fun\u00e7\u00e3o: upsertSlotDay_Capacity","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#explicacao-geral","title":"Explica\u00e7\u00e3o Geral","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#objetivo","title":"Objetivo","text":"<p>Criar ou atualizar o registro de um Slot di\u00e1rio (um dia espec\u00edfico de atendimento) para uma agenda que opera em modo capacidade.</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#modo-capacity","title":"Modo CAPACITY","text":"<p>Diferente do modo tradicional (com hor\u00e1rios), ele n\u00e3o cria subdivis\u00f5es de tempo \u2014 apenas define quantas marca\u00e7\u00f5es cabem por dia.</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#fluxo","title":"Fluxo","text":"<ol> <li>Verifica se j\u00e1 existe um slot para a data \u2192 atualiza se sim.  </li> <li>Se n\u00e3o existe \u2192 cria um novo slot.  </li> <li>Garante que o campo <code>hours</code> fique sempre vazio.  </li> <li>Controla o campo <code>isClosed</code> com base no n\u00famero de marca\u00e7\u00f5es (<code>appointment.count</code>).</li> </ol>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#b-criar-appointment-em-capacity-sem-selectedhour","title":"B) Criar Appointment em CAPACITY (sem selectedHour)","text":"<p>Objetivo: respeitar o <code>markingLimit</code> do dia sem timeboxes.</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#funcao-createappointmentcapacitymode","title":"Fun\u00e7\u00e3o: createAppointmentCapacityMode","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#explicacao-geral_1","title":"Explica\u00e7\u00e3o Geral","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#objetivo_1","title":"Objetivo","text":"<p>Criar uma nova marca\u00e7\u00e3o (appointment) em um slot do tipo capacidade, garantindo que: - O limite m\u00e1ximo de marca\u00e7\u00f5es do dia n\u00e3o seja ultrapassado. - Apenas profissionais autorizados possam registrar consultas. - O status do slot seja atualizado (fechado/aberto) conforme o n\u00famero de marca\u00e7\u00f5es.</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#modo-capacity_1","title":"Modo CAPACITY","text":"<p>Este modo n\u00e3o utiliza subdivis\u00f5es de hor\u00e1rios (<code>hours</code> fica vazio). Cada slot representa um \u00fanico dia e possui um limite de atendimentos.</p>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#fluxo_1","title":"Fluxo","text":"<ol> <li>Bloqueia o slot (com update sem altera\u00e7\u00e3o real) para evitar race conditions.  </li> <li>Valida se o slot est\u00e1 configurado corretamente para modo capacidade.  </li> <li>Confere se o profissional \u00e9 permitido (caso <code>inheritAllProfessionals</code> seja true).  </li> <li>Conta quantas marca\u00e7\u00f5es j\u00e1 existem no slot.  </li> <li>Impede cria\u00e7\u00e3o se a capacidade j\u00e1 foi atingida.  </li> <li>Cria a nova marca\u00e7\u00e3o (<code>appointment</code>).  </li> <li>Atualiza o status do slot (fecha se o limite for atingido).  </li> </ol>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#codigo-detalhado","title":"C\u00f3digo detalhado","text":"<pre><code>// Fun\u00e7\u00e3o ass\u00edncrona respons\u00e1vel por criar uma marca\u00e7\u00e3o (appointment)\n// em um slot configurado no modo CAPACITY (sem subdivis\u00f5es de hor\u00e1rio).\nasync function createAppointmentCapacityMode(prisma: any, {\n  slotId,              // ID do slot do dia onde ser\u00e1 feita a marca\u00e7\u00e3o\n  patientTaxId,        // Identificador fiscal do paciente\n  professionalTaxId,   // Identificador fiscal do profissional que atender\u00e1\n  typeOfService,       // Tipo de atendimento: presencial, telemedicina ou domiciliar\n  scheduleId,          // ID da agenda (opcional)\n  notes                // Notas adicionais (opcional)\n}: {\n  slotId: string;\n  patientTaxId: string;\n  professionalTaxId: string;\n  typeOfService: 'IN_PERSON'|'TELEMEDICINE'|'HOME';\n  scheduleId?: string|null;\n  notes?: string|null;\n}) {\n\n  // Inicia uma transa\u00e7\u00e3o para garantir integridade dos dados\n  // \u2014 todas as opera\u00e7\u00f5es abaixo ocorrem de forma at\u00f4mica.\n  return await prisma.$transaction(async (tx: any) =&gt; {\n\n    // Atualiza o campo \"updatedAt\" do slot apenas para for\u00e7ar um \"lock\" de linha.\n    // Isso previne condi\u00e7\u00f5es de corrida quando m\u00faltiplas marca\u00e7\u00f5es ocorrem simultaneamente.\n    const slot = await tx.slots.update({\n      where: { id: slotId },\n      data: { updatedAt: new Date() } // opera\u00e7\u00e3o \"no-op\"\n    });\n\n    // Valida se o slot possui subdivis\u00f5es de hor\u00e1rio.\n    // Caso tenha, este slot n\u00e3o deveria usar o modo CAPACITY.\n    if (Array.isArray(slot.hours) &amp;&amp; slot.hours.length &gt; 0) {\n      throw makeHttpError(409, 'Slot requires timed booking (hours present)');\n    }\n\n    // Caso o slot herde todos os profissionais, verifica se o atual \u00e9 permitido.\n    if (slot.inheritAllProfessionals) {\n      const allowed = (slot.availableProfessionalTaxIds ?? []).includes(professionalTaxId);\n      if (!allowed)\n        throw makeHttpError(403, 'Professional not allowed for this slot');\n    }\n\n    // Conta quantas marca\u00e7\u00f5es j\u00e1 existem neste slot (que n\u00e3o foram deletadas).\n    const currentCount = await tx.appointment.count({\n      where: { slotId: slot.id, deletedAt: null }\n    });\n\n    // Caso o n\u00famero de marca\u00e7\u00f5es atinja o limite m\u00e1ximo do slot, marca-o como fechado.\n    if (currentCount &gt;= slot.markingLimit) {\n      await tx.slots.update({\n        where: { id: slot.id },\n        data: { isClosed: true }\n      });\n      throw makeHttpError(409, 'Slot capacity reached');\n    }\n\n    // Cria uma nova marca\u00e7\u00e3o (appointment) associada ao slot.\n    const appt = await tx.appointment.create({\n      data: {\n        slotId: slot.id,                // Vincula ao slot do dia\n        selectedHour: null,             // Null no modo CAPACITY (sem hor\u00e1rio espec\u00edfico)\n        patientTaxId,                   // Identificador do paciente\n        professionalTaxId,              // Identificador do profissional\n        typeOfService,                  // Tipo de atendimento\n        status: 'PENDING',              // Status inicial\n        scheduleId: scheduleId ?? null, // Agenda associada, se houver\n        notes: notes ?? null            // Observa\u00e7\u00f5es adicionais\n      }\n    });\n\n    // Ap\u00f3s criar, incrementa o contador e verifica se o slot deve ser fechado.\n    const afterCount = currentCount + 1;\n    const willClose = afterCount &gt;= slot.markingLimit;\n\n    // Atualiza o estado do slot (fecha se atingiu a capacidade).\n    if (willClose || slot.isClosed !== willClose) {\n      await tx.slots.update({\n        where: { id: slot.id },\n        data: { isClosed: willClose }\n      });\n    }\n\n    // Retorna a marca\u00e7\u00e3o criada.\n    return appt;\n  });\n}\n\n// Fun\u00e7\u00e3o auxiliar que cria um erro HTTP com status e mensagem personalizados.\n// Usada para padronizar os erros retornados em caso de falhas de regra de neg\u00f3cio.\nfunction makeHttpError(status: number, message: string) {\n  const err: any = new Error(message);\n  err.status = status;\n  return err;\n}\n</code></pre>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#notas-importantes","title":"Notas importantes","text":"<ul> <li>O \u201clock\u201d via update garante serializa\u00e7\u00e3o suficiente para o contador (evita overbooking).</li> <li>Em Postgres, o ideal seria <code>SELECT ... FOR UPDATE</code>, mas com Prisma o padr\u00e3o \u00e9 usar update \u201cno-op\u201d dentro da transa\u00e7\u00e3o.</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#validacoes-extra-recomendadas","title":"Valida\u00e7\u00f5es extra recomendadas","text":""},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#na-criacaoatualizacao-da-agenda-schedules","title":"Na cria\u00e7\u00e3o/atualiza\u00e7\u00e3o da Agenda (Schedules):","text":"<ul> <li>Se <code>appointmentDurationInMinutes == null</code> \u2192 exigir <code>maxAppointmentsPerSlot &gt; 0</code></li> <li>Se <code>appointmentDurationInMinutes &gt; 0</code> \u2192 <code>maxAppointmentsPerSlot</code> pode ser vazio</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#na-geracao-de-slots","title":"Na gera\u00e7\u00e3o de Slots:","text":"<ul> <li>Em CAPACITY \u2192 <code>hours</code> vazio e <code>markingLimit &gt; 0</code></li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#na-reserva","title":"Na reserva:","text":"<ul> <li>Em CAPACITY \u2192 rejeitar <code>selectedHour</code> (422 \u201cselectedHour must be null in capacity mode\u201d)</li> <li>Validar <code>professionalTaxId</code> conforme <code>inheritAllProfessionals</code> e <code>availableProfessionalTaxIds</code></li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#erros-e-codigos-modo-capacidade","title":"Erros e c\u00f3digos (modo capacidade)","text":"Onde Regra C\u00f3digo Mensagem Criar Agenda <code>appointmentDurationInMinutes == null</code> e <code>maxAppointmentsPerSlot &lt;= 0</code> 422 Provide maxAppointmentsPerSlot when appointmentDurationInMinutes is null Gerar Slot CAPACITY mas <code>hours</code> veio preenchido 422 hours must be empty for capacity mode Reservar Slot \u00e9 TIMED mas endpoint CAPACITY foi usado 409 Slot requires timed booking (hours present) Reservar Profissional n\u00e3o autorizado 403 Professional not allowed for this slot Reservar Capacidade atingida 409 Slot capacity reached Reservar <code>selectedHour</code> enviado em CAPACITY 422 selectedHour must be null for capacity mode"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#sobre-indicesconstraints","title":"Sobre \u00edndices/constraints","text":"<ul> <li><code>@@unique([slotId, selectedHour, professionalTaxId])</code> n\u00e3o bloqueia CAPACITY</li> <li><code>selectedHour</code> \u00e9 <code>NULL</code> \u2192 Postgres permite m\u00faltiplos <code>NULLs</code></li> <li>A limita\u00e7\u00e3o de capacidade \u00e9 controlada na l\u00f3gica transacional, n\u00e3o no \u00edndice</li> </ul>"},{"location":"GuiadegeracaodeSlotsFormaB-capacidade/#recap","title":"Recap","text":"<p>No modo CAPACITY: - <code>Slot</code> n\u00e3o tem hor\u00e1rios \u2192 <code>hours = []</code> - <code>Appointment</code> usa apenas <code>slotId</code>, com <code>selectedHour = null</code> - A capacidade \u00e9 controlada por <code>Slots.markingLimit</code> - O <code>markingLimit</code> vem de <code>Schedules.maxAppointmentsPerSlot</code> - A verifica\u00e7\u00e3o \u00e9 transacional para evitar overbooking</p>"},{"location":"ModelosdeExclusaonaAgenda/","title":"Modelos de Exclus\u00e3o \u2013 Baika + Sa\u00fade (Atualizado pelo novo schema)","text":"<p>Este documento descreve como configurar bloqueios de disponibilidade usando os modelos <code>ExcludeRange</code> e <code>ExcludeDay</code>, de acordo com o schema atualizado.</p> <p>Prioridade geral: <code>ExcludeDay</code> (bloqueia o dia inteiro) &gt; <code>ExcludeRange</code> (bloqueia janelas/partes do dia). Timezone: Todas as datas/horas devem ser armazenadas e processadas em UTC (timestamptz).</p>"},{"location":"ModelosdeExclusaonaAgenda/#modelo-excluderange-bloqueios-parciais-janelas","title":"Modelo <code>ExcludeRange</code> (bloqueios parciais / janelas)","text":"<p>Usado para bloquear intervalos de tempo dentro de um dia (ex.: almo\u00e7o 12:00\u201313:00), por dias espec\u00edficos ou recorr\u00eancias (di\u00e1ria, semanal, RRULE), com escopo por unidade e agendas.</p>"},{"location":"ModelosdeExclusaonaAgenda/#estrutura-conforme-schema","title":"Estrutura (conforme schema)","text":"Campo Tipo Obrigat\u00f3rio Descri\u00e7\u00e3o <code>id</code> <code>String @id @default(uuid())</code> Sim Identificador \u00fanico. <code>startTime</code> <code>DateTime?</code> N\u00e3o Hora inicial para bloqueios recorrentes (interpreta\u00e7\u00e3o \u201crel\u00f3gio\u201d em UTC). <code>endTime</code> <code>DateTime?</code> N\u00e3o Hora final do bloqueio recorrente. <code>startDate</code> <code>DateTime? @db.Timestamptz</code> N\u00e3o Data/hora inicial para bloqueios pontuais ou de v\u00e1rios dias. <code>endDate</code> <code>DateTime? @db.Timestamptz</code> N\u00e3o Data/hora final do bloqueio pontual. <code>excludeForAllSlots</code> <code>Boolean @default(false)</code> Sim Se <code>true</code>, remove todos os hor\u00e1rios do(s) slot(s) na janela; se <code>false</code>, permite granularidade por lista/dia. <code>excludeFor</code> <code>WeekDays[] @default([])</code> N\u00e3o Dias da semana aplic\u00e1veis quando <code>typeOfRecurrence \u2260 NONE</code> (ignorado se <code>excludeForAllSlots = true</code>). <code>excludeForSpecificDates</code> <code>DateTime[] @default([])</code> N\u00e3o Datas pontuais a bloquear (p. ex., dias soltos no m\u00eas). <code>typeOfRecurrence</code> <code>TypeOfRecurrence @default(NONE)</code> Sim Frequ\u00eancia: <code>NONE/DAILY/WEEKLY/MONTHLY/.../CUSTOM</code>. <code>isActive</code> <code>Boolean @default(true)</code> Sim Liga/desliga o bloqueio. <code>healthUnitTaxId</code> <code>String</code> Sim Escopo: unidade de sa\u00fade a que o bloqueio pertence. <code>includeForAllUnitSchedules</code> <code>Boolean @default(false)</code> Sim Se <code>true</code>, aplica-se a todas as agendas da unidade (<code>healthUnitTaxId</code>). <code>assignedSchedules</code> <code>Schedules_ExcludeRange_[] @relation(\"Range\")</code> Condicional Rela\u00e7\u00e3o M:N para vincular agendas espec\u00edficas quando <code>includeForAllUnitSchedules = false</code>. <code>definedBy</code> <code>String</code> Sim Identificador do utilizador/sistema que criou. <code>rrule</code> <code>String?</code> N\u00e3o Regra iCalendar (RFC 5545), p. ex. <code>FREQ=WEEKLY;INTERVAL=2;BYDAY=SA</code>. <code>title</code> <code>String</code> Sim T\u00edtulo amig\u00e1vel (\u201cIntervalo de almo\u00e7o\u201d, \u201cForma\u00e7\u00e3o interna\u201d). <code>reason</code> <code>String?</code> N\u00e3o Motivo/descri\u00e7\u00e3o. <code>deletedAt</code> <code>DateTime?</code> N\u00e3o Soft-delete. <code>deletedBy</code> <code>String?</code> N\u00e3o Quem eliminou. <code>updatedAt</code> <code>DateTime @updatedAt</code> Sim Auditoria. <code>updatedBy</code> <code>String</code> Sim Quem actualizou por \u00faltimo."},{"location":"ModelosdeExclusaonaAgenda/#invariantes-de-governacao-escopo","title":"Invariantes de Governa\u00e7\u00e3o (escopo)","text":"<ul> <li>A) Se <code>includeForAllUnitSchedules = true</code> \u21d2 <code>assignedSchedules</code> deve estar vazio (aplica-se a todas as agendas da unidade).  </li> <li>B) Se <code>includeForAllUnitSchedules = false</code> \u21d2 <code>assignedSchedules</code> deve ter pelo menos 1 agenda.   <p>Caso contr\u00e1rio, o escopo fica amb\u00edguo.</p> </li> </ul>"},{"location":"ModelosdeExclusaonaAgenda/#validacoes-essenciais","title":"Valida\u00e7\u00f5es Essenciais","text":"<ul> <li>Quando usar <code>startTime</code>/<code>endTime</code> (recorrente), ambos devem existir e <code>startTime &lt; endTime</code>.  </li> <li>Em bloqueios pontuais, <code>startDate &lt;= endDate</code> (quando ambos informados).  </li> <li><code>typeOfRecurrence \u2260 NONE</code> e sem <code>excludeFor</code>/<code>rrule</code>/<code>excludeForSpecificDates</code> \u21d2 comportamento deve ser claramente definido (recomenda-se exigir ao menos uma dessas \u00e2ncoras).  </li> <li><code>isActive = false</code> \u21d2 o bloqueio n\u00e3o deve ser aplicado na gera\u00e7\u00e3o/c\u00e1lculo.</li> </ul>"},{"location":"ModelosdeExclusaonaAgenda/#interpretacao-engine","title":"Interpreta\u00e7\u00e3o (engine)","text":"<ol> <li>Determina escopo: unidade (<code>healthUnitTaxId</code>) e conjunto de agendas (<code>includeForAllUnitSchedules</code> vs <code>assignedSchedules</code>).  </li> <li>Expande recorr\u00eancias (<code>typeOfRecurrence</code> ou <code>rrule</code>) e/ou datas espec\u00edficas (<code>excludeForSpecificDates</code>).  </li> <li>Para cada dia alvo:</li> <li>Se dia foi totalmente exclu\u00eddo por ExcludeDay \u21d2 ignorar ExcludeRange (prioridade do dia).  </li> <li>Caso contr\u00e1rio, aplique a janelagem <code>startTime \u2192 endTime</code> e remova/etiquete horas como <code>BLOCKED</code>.  </li> <li>Nunca remover horas com <code>status \u2208 {BOOKED, HELD}</code>; no m\u00e1ximo, marcar como <code>BLOCKED</code> para futuras marca\u00e7\u00f5es.</li> </ol>"},{"location":"ModelosdeExclusaonaAgenda/#exemplos-payloads-logicos","title":"Exemplos (payloads l\u00f3gicos)","text":"<ul> <li>Intervalo di\u00e1rio (todos os schedules da unidade):</li> </ul> <pre><code>{\n  \"title\": \"Almo\u00e7o\",\n  \"reason\": \"Pausa operacional\",\n  \"typeOfRecurrence\": \"DAILY\",\n  \"startTime\": \"1970-01-01T12:00:00Z\",\n  \"endTime\": \"1970-01-01T13:00:00Z\",\n  \"excludeForAllSlots\": true,\n  \"includeForAllUnitSchedules\": true,\n  \"healthUnitTaxId\": \"5002159961\",\n  \"definedBy\": \"ops@baika\"\n}\n</code></pre> <ul> <li>Forma\u00e7\u00e3o semanal (apenas QUARTAS de agendas espec\u00edficas):</li> </ul> <pre><code>{\n  \"title\": \"Forma\u00e7\u00e3o Interna\",\n  \"typeOfRecurrence\": \"WEEKLY\",\n  \"excludeFor\": [\"WEDNESDAY\"],\n  \"startTime\": \"1970-01-01T14:00:00Z\",\n  \"endTime\": \"1970-01-01T17:00:00Z\",\n  \"excludeForAllSlots\": false,\n  \"includeForAllUnitSchedules\": false,\n  \"assignedSchedules\": [\"sch_123\",\"sch_456\"],\n  \"healthUnitTaxId\": \"5002159961\",\n  \"definedBy\": \"ops@baika\"\n}\n</code></pre> <ul> <li>Bloqueio pontual (janela de manuten\u00e7\u00e3o):</li> </ul> <pre><code>{\n  \"title\": \"Janela de Manuten\u00e7\u00e3o\",\n  \"startDate\": \"2025-10-21T08:00:00Z\",\n  \"endDate\": \"2025-10-21T10:00:00Z\",\n  \"excludeForAllSlots\": true,\n  \"includeForAllUnitSchedules\": true,\n  \"healthUnitTaxId\": \"5002159961\",\n  \"definedBy\": \"ops@baika\"\n}\n</code></pre>"},{"location":"ModelosdeExclusaonaAgenda/#modelo-excludeday-bloqueio-do-dia-inteiro","title":"Modelo <code>ExcludeDay</code> (bloqueio do dia inteiro)","text":"<p>Usado para remover um dia inteiro da disponibilidade (feriados, recessos, invent\u00e1rios). Tem prioridade sobre <code>ExcludeRange</code>.</p>"},{"location":"ModelosdeExclusaonaAgenda/#estrutura-conforme-schema_1","title":"Estrutura (conforme schema)","text":"Campo Tipo Obrigat\u00f3rio Descri\u00e7\u00e3o <code>id</code> <code>String @id @default(uuid())</code> Sim Identificador \u00fanico. <code>specificDate</code> <code>DateTime? @db.Timestamptz</code> N\u00e3o Data exacta (bloqueio pontual do dia inteiro). <code>weekDays</code> <code>WeekDays[]</code> N\u00e3o Dias recorrentes (ex.: <code>[SUNDAY]</code> para encerrar aos domingos). <code>typeOfRecurrence</code> <code>TypeOfRecurrence?</code> N\u00e3o Frequ\u00eancia para recorr\u00eancia semanal/mensal/etc. <code>rrule</code> <code>String?</code> N\u00e3o Regra iCalendar para padr\u00f5es anuais (ex.: feriados). <code>isActive</code> <code>Boolean @default(true)</code> Sim Liga/desliga. <code>healthUnitTaxId</code> <code>String</code> Sim Escopo por unidade. <code>schedules</code> <code>Schedule_ExcludeDay_[] @relation(\"Day\")</code> N\u00e3o Rela\u00e7\u00e3o M:N com agendas (quando a regra for por conjunto espec\u00edfico). <code>title</code> <code>String</code> Sim T\u00edtulo (ex.: \u201cNatal\u201d). <code>reason</code> <code>String?</code> N\u00e3o Motivo/descri\u00e7\u00e3o. <code>deletedAt</code> <code>DateTime?</code> N\u00e3o Soft-delete. <p>Observa\u00e7\u00e3o: o schema n\u00e3o define os campos <code>includeForAllUnitSchedules/definedBy/updatedBy</code> para <code>ExcludeDay</code>. O escopo por agenda \u00e9 definido via rela\u00e7\u00e3o M:N (<code>schedules</code>). Caso seja necess\u00e1rio \u201ctodas as agendas da unidade\u201d, convencionar n\u00e3o associar nenhuma agenda e tratar via pol\u00edtica (ou criar um <code>ExcludeDay</code> por agenda com um procedimento auxiliar).</p>"},{"location":"ModelosdeExclusaonaAgenda/#validacoes-essenciais_1","title":"Valida\u00e7\u00f5es Essenciais","text":"<ul> <li>Se usar <code>specificDate</code>, n\u00e3o usar simultaneamente uma <code>rrule</code> que resulte no mesmo dia (evitar duplicidade).  </li> <li><code>isActive = false</code> \u21d2 ignorar.  </li> <li>Quando usar <code>weekDays</code> com <code>typeOfRecurrence</code>, validar que o motor de gera\u00e7\u00e3o entende a combina\u00e7\u00e3o (ex.: <code>WEEKLY</code> + <code>[SUNDAY]</code>).</li> </ul>"},{"location":"ModelosdeExclusaonaAgenda/#exemplos","title":"Exemplos","text":"<ul> <li>Feriado anual (todas as agendas da unidade, via pol\u00edtica):</li> </ul> <pre><code>{\n  \"title\": \"Natal\",\n  \"rrule\": \"FREQ=YEARLY;BYMONTH=12;BYMONTHDAY=25\",\n  \"healthUnitTaxId\": \"5002159961\"\n}\n</code></pre> <ul> <li>Recesso pontual em dia espec\u00edfico para agendas selecionadas:</li> </ul> <pre><code>{\n  \"title\": \"Recesso P\u00f3s-Feriado\",\n  \"specificDate\": \"2025-12-26T00:00:00Z\",\n  \"healthUnitTaxId\": \"5002159961\",\n  \"schedules\": [\"sch_123\",\"sch_456\"]\n}\n</code></pre>"},{"location":"ModelosdeExclusaonaAgenda/#regras-de-prioridade-e-interacao","title":"Regras de Prioridade e Intera\u00e7\u00e3o","text":"<ol> <li><code>ExcludeDay</code> anula o dia inteiro (os slots do dia n\u00e3o s\u00e3o gerados ou s\u00e3o removidos).  </li> <li><code>ExcludeRange</code> aplica-se apenas se o dia n\u00e3o estiver bloqueado por <code>ExcludeDay</code>.  </li> <li>Em colis\u00e3o com horas BOOKED/HELD, n\u00e3o remova; apenas marque como <code>BLOCKED</code> e direcione o fluxo de reagendamento/cancelamento.  </li> <li><code>isActive = false</code> \u21d2 nenhuma a\u00e7\u00e3o.  </li> </ol>"},{"location":"ModelosdeExclusaonaAgenda/#recomendacoes-de-implementacao","title":"Recomenda\u00e7\u00f5es de Implementa\u00e7\u00e3o","text":"<ul> <li>UTC-only: normalize todos os campos <code>DateTime</code>/<code>Time</code> para UTC.  </li> <li>Engine de RRULE: validar RRULE no backend (rejeitar strings inv\u00e1lidas).  </li> <li>Escopo coerente: aplicar as invariantes A/B do <code>ExcludeRange</code> no servi\u00e7o antes de persistir.  </li> <li>Idempot\u00eancia: n\u00e3o duplicar bloqueios equivalentes; prefira upsert por <code>(healthUnitTaxId, title, per\u00edodo)</code> se fizer sentido no teu dom\u00ednio.</li> <li>Auditoria: utilizar <code>definedBy</code>, <code>updatedBy</code>, <code>updatedAt</code> (quando dispon\u00edveis) e logs com <code>correlationId</code> no processamento.</li> </ul>"},{"location":"ModelosdeExclusaonaAgenda/#erros-e-codigos-sugeridos","title":"Erros e C\u00f3digos sugeridos","text":"C\u00f3digo Quando Mensagem (exemplo) 400 Payload malformado / RRULE inv\u00e1lida <code>Invalid RRULE string</code> 401 N\u00e3o autenticado <code>Unauthorized</code> 403 Sem permiss\u00e3o para a unidade <code>Forbidden for healthUnitTaxId=...</code> 404 Agenda(s) referida(s) inexistente(s) <code>Schedule not found: sch_123</code> 409 Invariantes A/B violadas <code>Ambiguous scope: set includeForAllUnitSchedules OR assignedSchedules</code> 409 Colis\u00e3o com marca\u00e7\u00f5es existentes (pol\u00edtica r\u00edgida) <code>Cannot block occupied hour 2025-11-01T09:00Z</code> 422 Datas incoerentes <code>startDate must be &lt;= endDate</code> 422 Janelas inconsistentes <code>startTime must be before endTime</code> 422 Combina\u00e7\u00e3o incoerente de recorr\u00eancia <code>typeOfRecurrence requires excludeFor or rrule</code> 500 Erro interno <code>Failed to apply exclusions. correlationId=...</code>"},{"location":"ModelosdeExclusaonaAgenda/#exemplo-combinado-dia-janelas","title":"Exemplo combinado (dia + janelas)","text":"<pre><code>{\n  \"excludeDays\": [\n    { \"title\": \"Feriado Nacional\", \"rrule\": \"FREQ=YEARLY;BYMONTH=12;BYMONTHDAY=25\", \"healthUnitTaxId\": \"5002159961\" },\n    { \"title\": \"Recesso\", \"specificDate\": \"2025-12-26T00:00:00Z\", \"healthUnitTaxId\": \"5002159961\", \"schedules\": [\"sch_123\"] }\n  ],\n  \"excludeRanges\": [\n    { \"title\": \"Almo\u00e7o\", \"typeOfRecurrence\": \"DAILY\", \"startTime\": \"1970-01-01T12:00:00Z\", \"endTime\": \"1970-01-01T13:00:00Z\", \"excludeForAllSlots\": true, \"includeForAllUnitSchedules\": true, \"healthUnitTaxId\": \"5002159961\", \"definedBy\": \"ops@baika\" }\n  ]\n}\n</code></pre> <p>No exemplo acima: - <code>ExcludeDay</code> remove 25/12 (via RRULE) e 26/12 (pontual) \u2014 antes de qualquer <code>ExcludeRange</code> ser aplicado. - <code>ExcludeRange</code> bloqueia 12:00\u201313:00 em todos os schedules da unidade, em todos os dias (enquanto ativo).</p>"}]}