
# 4. Horários de Trabalho dos Profissionais e Atribuição Automática

No sistema, cada profissional possui **WorkingHour**, que define quando ele está disponível para atendimento. Essa informação é **fundamental** para gerar **slots e HourBoxes** corretos, garantindo que pacientes só possam marcar com profissionais realmente disponíveis.

---

## 4.1 Estrutura de WorkingHour

Cada **WorkingHour** inclui:

- **ProfessionalTaxId:** identificador do profissional
- **HealthUnitTaxId:** unidade de saúde onde trabalha
- **SpecialityCode:** especialidade
- **WeekDay:** dia da semana (segunda, terça, etc.)
- **StartAt / EndsAt:** horário de início e fim do atendimento
- **ValidFrom / ValidTo:** período de validade do horário (ex: contrato temporário, férias programadas)
- **TypeOfService:** presencial, telemedicina ou home care
- **ExcludedDays / ExcludedRanges:** bloqueios específicos aplicáveis ao profissional

### Exemplo prático:

- Dra. Ana (CRM: 12345), Cardiologista
- Unidade: Hospital São Lucas
- Segunda a Sexta: 13:00-18:00
- Sábado: 08:00-12:00
- Folga: Domingo
- Férias: 15/07 a 30/07 (usando ExcludeRange)

> O sistema só poderá gerar slots em horários compatíveis com esses dados.

---

## 4.2 Integração com Agenda (Schedule)

Quando uma **agenda** é criada:

1. **Definição da agenda:** ex: Pediatria, Segunda a Sexta, 08:00-12:00
2. **Escolha dos profissionais:** lista de **AvailableProfessionalTaxIds** ou todos disponíveis
3. **Recorrência e datas:** tipo de recorrência da agenda (diária, semanal, mensal)
4. **Geração automática de slots:** para cada dia que bate com a agenda:

   - O sistema verifica **WorkingHours de cada profissional**
   - Apenas profissionais com **horários compatíveis** são atribuídos aos slots
   - Slots podem ser:
     - **TIMED:** cada HourBox tem duração fixa (ex: 30min)
     - **CAPACITY:** hora cheia com capacidade máxima de pacientes

---

## 4.3 Processo de Atribuição Automática

1. **Para cada dia da agenda:**

   - Verifica se o dia não está em **ExcludeDay**
   - Cria um **Slot** correspondente ao dia

2. **Para cada hora da agenda (StartTime → EndTime):**

   - Divide em **HourBoxes** conforme **AppointmentDurationInMinutes**
   - Verifica horários ativos do profissional (**WorkingHour**)
   - Aplica **Excludes (Dias e Períodos)**

3. **Profissional é atribuído automaticamente:**

   - Se **EachSlotInheritAllScheduleProfessionals = true**, todos os profissionais disponíveis são atribuídos
   - Caso contrário, pode ser manual ou limitado

4. **Slots e HourBoxes resultantes:**

   - Só podem ser reservados se houver pelo menos um profissional disponível
   - HourBoxes em períodos bloqueados ficam **BLOCKED**

---

## 4.4 Exemplos Práticos

### Cenário 1: Slot TIMED com múltiplos profissionais

- Agenda: Segunda, 08:00-12:00, 30min por consulta
- Profissionais: Dra. Ana (13:00-18:00), Dr. Carlos (08:00-12:00)

**Resultado:**

| Hora  | HourBox Status | Profissional atribuído |
| ----- | -------------- | ---------------------- |
| 08:00 | AVAILABLE      | Dr. Carlos             |
| 08:30 | AVAILABLE      | Dr. Carlos             |
| 09:00 | AVAILABLE      | Dr. Carlos             |
| 13:00 | AVAILABLE      | Dra. Ana               |
| 13:30 | AVAILABLE      | Dra. Ana               |

> Dra. Ana só é atribuída nos horários compatíveis com seu WorkingHour.

---

### Cenário 2: Slot CAPACITY com profissional indisponível

- Slot: 08:00-12:00, capacidade 2
- Dra. Ana em férias 09:00-11:00

**Resultado HourBoxes:**

| Hora  | Status    | Profissional disponível |
| ----- | --------- | ----------------------- |
| 08:00 | AVAILABLE | Dra. Ana                |
| 09:00 | BLOCKED   | Nenhum                  |
| 09:30 | BLOCKED   | Nenhum                  |
| 10:00 | BLOCKED   | Nenhum                  |
| 11:00 | AVAILABLE | Dra. Ana                |

---

## 4.5 Considerações importantes

- **Recorrência da agenda:** o sistema aplica automaticamente os WorkingHours de cada profissional em cada dia da recorrência.
- **Exclusões:** sempre são aplicadas antes da geração de HourBoxes. Um HourBox só é gerado se não houver conflito com **ExcludeDay** ou **ExcludeRange**.
- **Slots vazios:** se não houver profissional disponível, o slot inteiro pode ser **bloqueado** ou removido da publicação, dependendo das configurações.
- **Telemedicina:** se o tipo de serviço for online, RoomLink é gerado automaticamente para os HourBoxes atribuídos a cada profissional.
