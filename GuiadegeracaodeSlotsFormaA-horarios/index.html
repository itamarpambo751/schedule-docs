
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://itamarpambo751.github.io/Consultation-Docs/GuiadegeracaodeSlotsFormaA-horarios/">
      
      
        <link rel="prev" href="../ModelosdeExclusaonaAgenda/">
      
      
        <link rel="next" href="../GuiadegeracaodeSlotsFormaB-capacidade/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>3. Guia de geração de Slots Forma A (Horarios) - API Gestao de Agendas e Marcacoes de Consultas</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#guia-de-slots-implementacao-marcacao-com-horarios-nos-slots" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabeçalho">
    <a href=".." title="API Gestao de Agendas e Marcacoes de Consultas" class="md-header__button md-logo" aria-label="API Gestao de Agendas e Marcacoes de Consultas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            API Gestao de Agendas e Marcacoes de Consultas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. Guia de geração de Slots Forma A (Horarios)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Modo escuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Modo escuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Pesquisar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpar" aria-label="Limpar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando a pesquisa
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegação" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="API Gestao de Agendas e Marcacoes de Consultas" class="md-nav__button md-logo" aria-label="API Gestao de Agendas e Marcacoes de Consultas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    API Gestao de Agendas e Marcacoes de Consultas
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Início
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Visão Geral
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Visão Geral
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Conceitos-base do Sistema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Exclusões e Folgas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Horários de Trabalho dos Profissionais e Atribuição Automática
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Marcação de Consultas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Exclusões de Dias e Períodos
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Horários de Trabalho dos Profissionais
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Slots e HourBoxes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Marcação de Consultas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exclusões e Bloqueios Avançados
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Horários de Trabalho de Profissionais
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Visão Tecnica e regras de negócio
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Visão Tecnica e regras de negócio
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../GuiaDeConfiguracaoDaAgenda/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Guia de configuração de agenda
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ModelosdeExclusaonaAgenda/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Modelo de Exclusao na Agenda
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    3. Guia de geração de Slots Forma A (Horarios)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Guia de geração de Slots Forma A (Horarios)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelo-prisma-slots-atualizado" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modelo Prisma — Slots (atualizado)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-invariantes-recomendados" class="md-nav__link">
    <span class="md-ellipsis">
      
        1) Invariantes Recomendados
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-esquema-do-json-hours" class="md-nav__link">
    <span class="md-ellipsis">
      
        2) Esquema do JSON hours
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2) Esquema do JSON hours">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#derivacao-sugerida-de-isfilled-a-partir-de-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        Derivação sugerida de isFilled a partir de status
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-geracao-merge-de-horas" class="md-nav__link">
    <span class="md-ellipsis">
      
        3) Geração &amp; MERGE de horas
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3) Geração &amp; MERGE de horas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-principios" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Princípios
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-tiposhelpers-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Tipos/Helpers (TypeScript)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-upsert-idempotente-do-slot-por-dia" class="md-nav__link">
    <span class="md-ellipsis">
      
        4) Upsert idempotente do Slot (por dia)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-exclusoes" class="md-nav__link">
    <span class="md-ellipsis">
      
        5) Exclusões
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-validacoes-rapidas" class="md-nav__link">
    <span class="md-ellipsis">
      
        6) Validações rápidas
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-indices-e-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        7) Índices e Constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-fluxo-de-reserva" class="md-nav__link">
    <span class="md-ellipsis">
      
        8) Fluxo de Reserva
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-erros-comuns-e-codigos" class="md-nav__link">
    <span class="md-ellipsis">
      
        9) Erros Comuns e Códigos
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-checklist-de-testes" class="md-nav__link">
    <span class="md-ellipsis">
      
        10) Checklist de Testes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../GuiadegeracaodeSlotsFormaB-capacidade/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Guia de geração de Slots Forma B (Capacidade)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelo-prisma-slots-atualizado" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modelo Prisma — Slots (atualizado)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-invariantes-recomendados" class="md-nav__link">
    <span class="md-ellipsis">
      
        1) Invariantes Recomendados
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-esquema-do-json-hours" class="md-nav__link">
    <span class="md-ellipsis">
      
        2) Esquema do JSON hours
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2) Esquema do JSON hours">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#derivacao-sugerida-de-isfilled-a-partir-de-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        Derivação sugerida de isFilled a partir de status
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-geracao-merge-de-horas" class="md-nav__link">
    <span class="md-ellipsis">
      
        3) Geração &amp; MERGE de horas
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3) Geração &amp; MERGE de horas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-principios" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Princípios
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-tiposhelpers-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Tipos/Helpers (TypeScript)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-upsert-idempotente-do-slot-por-dia" class="md-nav__link">
    <span class="md-ellipsis">
      
        4) Upsert idempotente do Slot (por dia)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-exclusoes" class="md-nav__link">
    <span class="md-ellipsis">
      
        5) Exclusões
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-validacoes-rapidas" class="md-nav__link">
    <span class="md-ellipsis">
      
        6) Validações rápidas
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-indices-e-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        7) Índices e Constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-fluxo-de-reserva" class="md-nav__link">
    <span class="md-ellipsis">
      
        8) Fluxo de Reserva
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-erros-comuns-e-codigos" class="md-nav__link">
    <span class="md-ellipsis">
      
        9) Erros Comuns e Códigos
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-checklist-de-testes" class="md-nav__link">
    <span class="md-ellipsis">
      
        10) Checklist de Testes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="guia-de-slots-implementacao-marcacao-com-horarios-nos-slots">Guia de Slots — Implementação (Marcação com horários nos Slots)</h1>
<p>Este documento descreve as <strong>regras, invariantes, formato do JSON <code>hours</code></strong> e o <strong>fluxo de geração/merge</strong> de horas para o modelo <code>Slots</code>, <strong>alinhado com o schema Prisma mais recente</strong> (inclui campos de visibilidade/publicação e aprovação).</p>
<blockquote>
<p><strong>UTC sempre:</strong> todas as datas/horas devem ser <code>timestamptz</code> em UTC.<br />
<strong>Idempotência:</strong> operações de geração/merge NUNCA devem apagar horas ocupadas (BOOKED/HELD) nem quebrar histórico.<br />
<strong>Políticas:</strong> <code>ExcludeDay</code> tem prioridade sobre <code>ExcludeRange</code>.</p>
</blockquote>
<hr />
<h2 id="modelo-prisma-slots-atualizado">Modelo Prisma — Slots (atualizado)</h2>
<pre><code class="language-prisma">model Slots {
  id                          String   @id @default(uuid())
  inheritAllProfessionals     Boolean  @default(true)         // herda profissionais do Schedule?
  availableProfessionalTaxIds String[] @default([])           // lista específica quando não herda
  weekDay                     WeekDays                        // dia da semana em UTC
  specificDate                DateTime @db.Timestamptz        // dia do slot (00:00:00Z)
  markingLimit                Int                              // capacidade do dia
  isClosed                    Boolean  @default(false)         // fechado (capacidade atingida)

  genderRestriction GenderRestrictions @default(NONE)

  scheduleId String
  schedule   Schedules @relation(fields: [scheduleId], references: [id], onDelete: Restrict)

  /**
   * Estrutura JSON em `hours` (sempre UTC):
   * [
   *   {
   *     &quot;hour&quot;: &quot;2025-10-20T08:00:00Z&quot;,
   *     &quot;status&quot;: &quot;AVAILABLE&quot; | &quot;HELD&quot; | &quot;BOOKED&quot; | &quot;CANCELLED&quot; | &quot;BLOCKED&quot;,
   *     &quot;appointmentId&quot;: null,
   *     &quot;professionalTaxId&quot;: null,
   *     &quot;roomLink&quot;: null,
   *     &quot;remarks&quot;: null,
   *     &quot;updatedAt&quot;: &quot;2025-10-18T12:00:00Z&quot;,
   *     &quot;filledBy&quot;: null
   *   }
   * ]
   */
  hours Json

  appointments Appointment[]

  // Publicação &amp; revisão
  visibility       SlotVisibility @default(DRAFT)  // DRAFT | PUBLISHED | REJECTED | ARCHIVED
  approvalRequired Boolean        @default(true)   // exige aprovação?
  submittedByTaxId String?                         // quem submeteu para revisão
  reviewedByTaxId  String?                         // quem aprovou/rejeitou
  reviewedAt       DateTime?      @db.Timestamptz
  publishAt        DateTime?      @db.Timestamptz  // quando foi/será publicado
  reviewNotes      String?

  // Guardas de janela de publicação (opcionais)
  publishNotBefore DateTime? @db.Timestamptz
  publishExpiresAt DateTime? @db.Timestamptz

  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  deletedAt DateTime?

  // Índices &amp; unicidade
  @@unique([scheduleId, specificDate])
  @@index([visibility, specificDate])
  @@index([publishAt])
  @@index([scheduleId, specificDate])
  @@index([scheduleId, weekDay])
  @@index([deletedAt])
}
</code></pre>
<blockquote>
<p><strong>Nota:</strong> mantenha o par único <code>@@unique([scheduleId, specificDate])</code> para garantir <strong>um slot por dia</strong> para cada agenda.</p>
</blockquote>
<hr />
<h2 id="1-invariantes-recomendados">1) Invariantes Recomendados</h2>
<ul>
<li><strong>Unicidade (um dia por agenda):</strong> <code>@@unique([scheduleId, specificDate])</code>  </li>
<li><strong>UTC Sempre:</strong> <code>specificDate</code> e <code>hours[i].hour</code> em UTC  </li>
<li><strong><code>markingLimit</code> consistente:</strong></li>
<li><strong>Via A (grelha por duração):</strong> capacidade = <code>#timeboxes × (multi-atendimento opcional)</code>  </li>
<li><strong>Via B (dia-como-slot):</strong> capacidade = <code>maxAppointmentsPerSlot</code> do Schedule</li>
<li><strong>Fecho automático:</strong> <code>isClosed = true</code> quando capacidade atingida / todas as boxes ocupadas</li>
<li><strong>Herança de profissionais:</strong> <code>inheritAllProfessionals = true</code> → usar <code>schedule.availableProfessionalTaxIds</code></li>
</ul>
<hr />
<h2 id="2-esquema-do-json-hours">2) Esquema do JSON <code>hours</code></h2>
<pre><code class="language-json">[
  {
    &quot;hour&quot;: &quot;2025-10-20T08:00:00Z&quot;,
    &quot;status&quot;: &quot;AVAILABLE&quot;,
    &quot;isFilled&quot;: false,
    &quot;appointmentId&quot;: null,
    &quot;professionalTaxId&quot;: null,
    &quot;roomLink&quot;: null,
    &quot;remarks&quot;: null,
    &quot;updatedAt&quot;: &quot;2025-10-18T12:00:00Z&quot;,
    &quot;filledBy&quot;: null
  }
]
</code></pre>
<h3 id="derivacao-sugerida-de-isfilled-a-partir-de-status">Derivação sugerida de <code>isFilled</code> a partir de <code>status</code></h3>
<table>
<thead>
<tr>
<th style="text-align: right;">status</th>
<th style="text-align: center;">isFilled</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">AVAILABLE</td>
<td style="text-align: center;">false</td>
</tr>
<tr>
<td style="text-align: right;">HELD</td>
<td style="text-align: center;">true</td>
</tr>
<tr>
<td style="text-align: right;">BOOKED</td>
<td style="text-align: center;">true</td>
</tr>
<tr>
<td style="text-align: right;">CANCELLED</td>
<td style="text-align: center;">false</td>
</tr>
<tr>
<td style="text-align: right;">BLOCKED</td>
<td style="text-align: center;">true</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-geracao-merge-de-horas">3) Geração &amp; MERGE de horas</h2>
<h3 id="31-principios">3.1 Princípios</h3>
<ul>
<li><strong>NUNCA</strong> sobrescrever/remover horas <strong>BOOKED/HELD/BLOCKED</strong>  </li>
<li><strong>Adicionar</strong> novas horas quando a grelha aumentar  </li>
<li><strong>Remover</strong> apenas horas <strong>AVAILABLE/CANCELLED</strong> que ficaram fora do novo cálculo  </li>
<li><strong>UTC</strong> em toda a pipeline</li>
</ul>
<h3 id="32-tiposhelpers-typescript">3.2 Tipos/Helpers (TypeScript)</h3>
<pre><code class="language-ts">type HourBox = {
  hour: string; // ISO UTC
  status: 'AVAILABLE'|'HELD'|'BOOKED'|'CANCELLED'|'BLOCKED';
  appointmentId?: string|null;
  professionalTaxId?: string|null;
  roomLink?: string|null;
  remarks?: string|null;
  updatedAt?: string;
  filledBy?: string|null;
};

/** Merge idempotente &amp; seguro */
function mergeHoursSafely(existing: HourBox[], incoming: HourBox[]): HourBox[] {
  const byKey = new Map(existing.map(h =&gt; [h.hour, h]));
  for (const h of incoming) {
    const cur = byKey.get(h.hour);
    if (!cur) { byKey.set(h.hour, h); continue; }
    const occupied = ['BOOKED','HELD','BLOCKED'].includes(cur.status);
    if (occupied) continue;
    byKey.set(h.hour, { ...cur, ...h, updatedAt: new Date().toISOString() });
  }
  const incomingSet = new Set(incoming.map(h =&gt; h.hour));
  return Array.from(byKey.values()).filter(h =&gt; {
    const keepOccupied = ['BOOKED','HELD','BLOCKED'].includes(h.status);
    if (keepOccupied) return true;
    return incomingSet.has(h.hour);
  });
}

/** Projeta HH:mm:ss do Schedule numa data específica (UTC) */
function projectScheduleTimeToDate(scheduleTimeUtc: Date, dayUtc: Date) {
  return new Date(Date.UTC(
    dayUtc.getUTCFullYear(),
    dayUtc.getUTCMonth(),
    dayUtc.getUTCDate(),
    scheduleTimeUtc.getUTCHours(),
    scheduleTimeUtc.getUTCMinutes(),
    scheduleTimeUtc.getUTCSeconds()
  ));
}

/** Grelha via duração (Via A) */
function buildHoursGrid(schedule: {
  startTime: string | Date;
  endTime: string | Date;
  appointmentDurationInMinutes: number;
}, dayUtc: Date): HourBox[] {
  if (!schedule.appointmentDurationInMinutes || schedule.appointmentDurationInMinutes &lt;= 0) {
    throw new Error('buildHoursGrid requer appointmentDurationInMinutes &gt; 0');
  }
  const start = projectScheduleTimeToDate(new Date(schedule.startTime), dayUtc);
  const end   = projectScheduleTimeToDate(new Date(schedule.endTime), dayUtc);
  if (+end &lt;= +start) throw new Error('startTime deve ser anterior a endTime');

  const stepMs = Math.floor(schedule.appointmentDurationInMinutes) * 60_000;
  const out: HourBox[] = [];
  for (let t = +start; t &lt; +end; t += stepMs) {
    out.push({ hour: new Date(t).toISOString(), status: 'AVAILABLE', appointmentId: null, professionalTaxId: null, updatedAt: new Date().toISOString() });
  }
  return out;
}

/** Grelha via capacidade (Via B — dia como slot) */
function buildCapacityBoxes(schedule: { maxAppointmentsPerSlot?: number|null }, dayUtc: Date): HourBox[] {
  const cap = schedule.maxAppointmentsPerSlot &amp;&amp; schedule.maxAppointmentsPerSlot &gt; 0 ? schedule.maxAppointmentsPerSlot : 1;
  const base = new Date(Date.UTC(dayUtc.getUTCFullYear(), dayUtc.getUTCMonth(), dayUtc.getUTCDate(), 0, 0, 0));
  return Array.from({ length: cap }, (_, i) =&gt; ({
    hour: new Date(+base + i).toISOString(),
    status: 'AVAILABLE',
    appointmentId: null,
    professionalTaxId: null,
    updatedAt: new Date().toISOString()
  }));
}

/** Exclusões (stub) — aplicar ExcludeDay &gt; ExcludeRange */
function applyExcludeRanges(baseHours: HourBox[], excludeRanges: any[], dayUtc: Date): HourBox[] {
  // Implementar conforme políticas locais:
  // - Remover/recortar janelas (12:00–13:00) e datas pontuais
  // - Honrar RRULE
  // - Nunca remover BOOKED/HELD; marcar como BLOCKED se necessário
  return baseHours;
}

/** Capacidade &amp; fecho */
function deriveMarkingLimit(schedule: any, hours: HourBox[]): number {
  if (typeof schedule.maxAppointmentsPerSlot === 'number' &amp;&amp; schedule.maxAppointmentsPerSlot &gt; 0) return schedule.maxAppointmentsPerSlot;
  return hours.length;
}
function inferCapacityFromGrid(hours: HourBox[]): number { return hours.length; }
function countFilled(hours: HourBox[]): number { return hours.filter(h =&gt; ['BOOKED','HELD'].includes(h.status)).length; }
function allTimeBoxesFilled(hours: HourBox[]): boolean { return hours.every(h =&gt; ['BOOKED','HELD','BLOCKED'].includes(h.status)); }
function weekday(d: Date): 'SUNDAY'|'MONDAY'|'TUESDAY'|'WEDNESDAY'|'THURSDAY'|'FRIDAY'|'SATURDAY' {
  return ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'][d.getUTCDay()] as any;
}
</code></pre>
<hr />
<h2 id="4-upsert-idempotente-do-slot-por-dia">4) Upsert idempotente do Slot (por dia)</h2>
<pre><code class="language-ts">async function upsertSlotDay({
  prisma,
  schedule,
  dateUtc,
  inheritAll
}: {
  prisma: any; // PrismaClient
  schedule: {
    id: string;
    startTime: string | Date;
    endTime: string | Date;
    appointmentDurationInMinutes?: number | null;
    maxAppointmentsPerSlot?: number | null;
    availableProfessionalTaxIds?: string[] | null;
    excludeRanges?: any[];
  };
  dateUtc: Date;
  inheritAll: boolean;
}) {
  const usesDuration = !!schedule.appointmentDurationInMinutes &amp;&amp; schedule.appointmentDurationInMinutes &gt; 0;
  const baseHours = usesDuration
    ? buildHoursGrid(schedule as any, dateUtc)
    : buildCapacityBoxes(schedule as any, dateUtc);

  const hoursAfterExclude = applyExcludeRanges(baseHours, schedule.excludeRanges ?? [], dateUtc);

  const existing = await prisma.slots.findUnique({
    where: { scheduleId_specificDate: { scheduleId: schedule.id, specificDate: dateUtc } }
  });

  const base = existing ?? {
    scheduleId: schedule.id,
    specificDate: dateUtc,
    weekDay: weekday(dateUtc),
    inheritAllProfessionals: inheritAll,
    availableProfessionalTaxIds: inheritAll ? (schedule.availableProfessionalTaxIds ?? []) : [],
    markingLimit: deriveMarkingLimit(schedule as any, hoursAfterExclude),
    isClosed: false,
    hours: [] as HourBox[]
  };

  const merged = mergeHoursSafely(base.hours as HourBox[], hoursAfterExclude);
  const capacity = base.markingLimit ?? inferCapacityFromGrid(merged);
  const isClosed = countFilled(merged) &gt;= capacity || allTimeBoxesFilled(merged);

  if (existing) {
    await prisma.slots.update({
      where: { id: existing.id },
      data: {
        hours: merged,
        isClosed,
        availableProfessionalTaxIds: base.inheritAllProfessionals
          ? (schedule.availableProfessionalTaxIds ?? [])
          : base.availableProfessionalTaxIds
      }
    });
    return existing.id;
  }

  const created = await prisma.slots.create({ data: { ...base, hours: merged, isClosed } });
  return created.id;
}
</code></pre>
<hr />
<h2 id="5-exclusoes">5) Exclusões</h2>
<p><strong>Prioridade:</strong> <code>ExcludeDay &gt; ExcludeRange</code><br />
- <code>ExcludeDay</code> → remove o dia inteiro<br />
- <code>ExcludeRange</code> → corta/remarca intervalos</p>
<p><strong>Regra de ouro:</strong><br />
- <code>BOOKED/HELD</code> → <strong>nunca remover</strong><br />
- <code>AVAILABLE/CANCELLED</code> → podem ser removidos ou marcados como <code>BLOCKED</code></p>
<hr />
<h2 id="6-validacoes-rapidas">6) Validações rápidas</h2>
<ul>
<li><code>specificDate</code> em UTC  </li>
<li><code>weekDay === weekday(specificDate)</code>  </li>
<li><code>inheritAllProfessionals = true</code> → ignorar <code>availableProfessionalTaxIds</code> do payload  </li>
<li><code>hours[*].hour</code> sem duplicados e <strong>sempre ISO-8601 UTC</strong>  </li>
<li>Em reserva, validar se <code>professionalTaxId</code> pertence à lista herdada ou específica do slot</li>
</ul>
<hr />
<h2 id="7-indices-e-constraints">7) Índices e Constraints</h2>
<pre><code class="language-prisma">@@unique([scheduleId, specificDate])
@@index([visibility, specificDate])
@@index([publishAt])
@@index([scheduleId, specificDate])
@@index([scheduleId, weekDay])
@@index([deletedAt])
</code></pre>
<hr />
<h2 id="8-fluxo-de-reserva">8) Fluxo de Reserva</h2>
<ol>
<li>Selecionar <code>hour</code> no JSON do Slot  </li>
<li>Validar <code>status === 'AVAILABLE'</code> e autorização do profissional  </li>
<li>Criar <code>Appointment</code> e atualizar <code>hours[i]</code> (<code>status → BOOKED</code>, <code>appointmentId</code>)  </li>
<li>Atualizar <code>isClosed</code> conforme capacidade  </li>
<li>Em conflito → <code>409 Conflict</code></li>
</ol>
<hr />
<h2 id="9-erros-comuns-e-codigos">9) Erros Comuns e Códigos</h2>
<table>
<thead>
<tr>
<th>Situação</th>
<th>Código</th>
<th>Mensagem</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duplicar slot no mesmo dia/agenda</td>
<td>409</td>
<td>Slot for this schedule and date already exists</td>
</tr>
<tr>
<td><code>hours[*].hour</code> inválido ou não UTC</td>
<td>422</td>
<td>hours[*].hour must be ISO-8601 UTC</td>
</tr>
<tr>
<td>Misturar Via A e Via B</td>
<td>422</td>
<td>Provide appointmentDurationInMinutes or maxAppointmentsPerSlot</td>
</tr>
<tr>
<td>Remover hora com marcação/hold</td>
<td>409</td>
<td>Cannot remove booked/held hour</td>
</tr>
<tr>
<td>Profissional não autorizado</td>
<td>403</td>
<td>Professional not allowed for this slot</td>
</tr>
<tr>
<td><code>weekDay</code> não corresponde a <code>specificDate</code></td>
<td>422</td>
<td>weekDay must match specificDate</td>
</tr>
<tr>
<td>Falha de idempotência/concurrency</td>
<td>409</td>
<td>Slot generation already in progress</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="10-checklist-de-testes">10) Checklist de Testes</h2>
<ul>
<li>Geração <strong>Via A</strong> (duração) e <strong>Via B</strong> (capacidade)  </li>
<li>Merge preserva <strong>BOOKED/HELD/BLOCKED</strong>  </li>
<li>Exclusões respeitam <strong>ExcludeDay &gt; ExcludeRange</strong>  </li>
<li>Projeção UTC correta em virada de mês/ano  </li>
<li>Herança de profissionais (on/off)  </li>
<li><code>isClosed</code> liga/desliga conforme capacidade  </li>
<li>Reserva concorrente → <code>409 Conflict</code>  </li>
<li>Soft-delete não afeta consultas históricas</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "search.result.more.one": "Mais 1 nesta p\u00e1gina", "search.result.more.other": "Mais # nesta p\u00e1gina", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.placeholder": "Digite para iniciar a busca", "search.result.term.missing": "Ausente", "select.version": "Selecione a vers\u00e3o"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>